<script type="module">
        // --- 1. ÐŸÐžÐ”ÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, runTransaction, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYIn-rdlk6sRe49J99PDN3ESD_668dChg",
            authDomain: "ws3eqr-db.firebaseapp.com",
            databaseURL: "https://ws3eqr-db-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ws3eqr-db",
            storageBucket: "ws3eqr-db.firebasestorage.app",
            messagingSenderId: "411483957904",
            appId: "1:411483957904:web:9377403d0aa36851fe0615"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 2. Ð“Ð›ÐžÐ‘ÐÐ›Ð¬ÐÐ«Ð• ÐŸÐ•Ð Ð•ÐœÐ•ÐÐÐ«Ð• ---
        let boardState = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'O';
        let gameActive = true;
        let gameMode = 'pve'; 
        let playerSymbol = 'O'; 
        let aiSymbol = 'X';
        
        // ÐÐ¸ÐºÐ½ÐµÐ¹Ð¼ Ð¸Ð³Ñ€Ð¾ÐºÐ° (Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð»Ð¸ Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· Ð¿Ð°Ð¼ÑÑ‚Ð¸)
        let myNickname = localStorage.getItem('ws_nickname');
        if(!myNickname) {
            myNickname = "Player_" + Math.floor(Math.random() * 9999);
            localStorage.setItem('ws_nickname', myNickname);
        }

        // --- 3. Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð˜Ð“Ð Ð« ---
        // Ð”ÐµÐ»Ð°ÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¼Ð¸ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾ (window), Ñ‚Ð°Ðº ÐºÐ°Ðº Ñƒ Ð½Ð°Ñ type="module"
        window.onload = () => {
            simulateLoading();
            loadLeaderboard(); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚Ð¾Ð¿ Ð¸Ð· Ð±Ð°Ð·Ñ‹
        };

        function simulateLoading() {
            let width = 0;
            const bar = document.getElementById('progress');
            const interval = setInterval(() => {
                width += Math.random() * 10;
                if(width >= 100) {
                    width = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('games-menu').style.display = 'block';
                    }, 500);
                }
                bar.style.width = width + '%';
            }, 100);
        }

        // --- 4. Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥ (Ð¢ÐžÐŸ Ð˜Ð“Ð ÐžÐšÐžÐ’) ---
        
        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð±ÐµÐ´Ñƒ
        function saveWinToDB() {
            // Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð² Ð±Ð°Ð·Ðµ
            const userRef = ref(db, 'leaderboard/' + myNickname);
            
            // runTransaction Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð¿Ñ€Ð¸Ð±Ð°Ð²Ð¸Ñ‚ÑŒ +1
            runTransaction(userRef, (currentData) => {
                if (currentData === null) {
                    return { wins: 1, name: myNickname };
                } else {
                    return { wins: (currentData.wins || 0) + 1, name: myNickname };
                }
            });
        }

        // Ð¡Ð»ÑƒÑˆÐ°Ñ‚ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð¿Ð°
        function loadLeaderboard() {
            const topRef = query(ref(db, 'leaderboard'), orderByChild('wins'), limitToLast(10));
            
            onValue(topRef, (snapshot) => {
                const list = [];
                snapshot.forEach((child) => {
                    list.push(child.val());
                });
                // Ð‘Ð°Ð·Ð° Ð¾Ñ‚Ð´Ð°ÐµÑ‚ Ð¾Ñ‚ Ð¼ÐµÐ½ÑŒÑˆÐµÐ³Ð¾ Ðº Ð±Ð¾Ð»ÑŒÑˆÐµÐ¼Ñƒ, Ð¿ÐµÑ€ÐµÐ²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼
                list.reverse();

                let html = "";
                list.forEach((player, index) => {
                    let style = "";
                    if(player.name === myNickname) style = "color: #00ffcc; border: 1px dashed #333;";
                    
                    html += `<div class="leaderboard-item" style="${style}">
                        <span class="lb-name">${index+1}. ${player.name}</span>
                        <span class="lb-score">${player.wins}</span>
                    </div>`;
                });

                // Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð¾Ð±Ð° Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (Ð¿Ð¾ÐºÐ° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°)
                const lbAi = document.getElementById('lb-ai');
                if(lbAi) lbAi.innerHTML = html;
                
                const lbHuman = document.getElementById('lb-human');
                if(lbHuman) lbHuman.innerHTML = html;
            });
        }

        // --- 5. Ð›ÐžÐ“Ð˜ÐšÐ Ð˜Ð“Ð Ð« ---
        
        window.openTicTacToe = function() {
            document.getElementById('games-menu').style.display = 'none';
            document.getElementById('tictactoe-screen').style.display = 'flex';
            resetGame();
        }

        window.backToMenu = function() {
            document.getElementById('tictactoe-screen').style.display = 'none';
            document.getElementById('games-menu').style.display = 'block';
        }

        window.toggleSettings = function() {
            document.getElementById('settings-overlay').classList.toggle('open');
            // ÐŸÑ€Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸Ðº
            // const newNick = prompt("Ð¢Ð²Ð¾Ð¹ Ð½Ð¸Ðº:", myNickname);
            // if(newNick) { myNickname = newNick; localStorage.setItem('ws_nickname', newNick); }
        }

        window.setTheme = function(color) {
            const r = document.documentElement;
            if(color === 'white') {
                r.style.setProperty('--bg-color', '#ffffff'); r.style.setProperty('--text-color', '#000000'); r.style.setProperty('--panel-bg', '#f0f0f0'); r.style.setProperty('--border-color', '#ccc');
            } else if(color === 'pink') {
                r.style.setProperty('--bg-color', '#ffc0cb'); r.style.setProperty('--text-color', '#590016'); r.style.setProperty('--panel-bg', '#fff0f5'); r.style.setProperty('--border-color', '#ff69b4');
            } else if(color === 'gray') {
                r.style.setProperty('--bg-color', '#333333'); r.style.setProperty('--text-color', '#ffffff'); r.style.setProperty('--panel-bg', '#444444'); r.style.setProperty('--border-color', '#666');
            } else { 
                r.style.setProperty('--bg-color', '#000000'); r.style.setProperty('--text-color', '#ffffff'); r.style.setProperty('--panel-bg', '#111111'); r.style.setProperty('--border-color', '#333');
            }
        }

        window.setMode = function(mode) {
            gameMode = mode;
            document.getElementById('btn-pve').classList.remove('active');
            document.getElementById('btn-multi').classList.remove('active');
            
            if(mode === 'pve') {
                document.getElementById('btn-pve').classList.add('active');
                document.getElementById('side-selector').style.display = 'block';
            } else {
                document.getElementById('btn-multi').classList.add('active');
                document.getElementById('side-selector').style.display = 'none';
            }
            resetGame();
        }

        window.toggleSide = function() {
            if(playerSymbol === 'O') {
                playerSymbol = 'X'; aiSymbol = 'O';
                document.getElementById('player-side').innerText = 'X (Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹)';
            } else {
                playerSymbol = 'O'; aiSymbol = 'X';
                document.getElementById('player-side').innerText = 'O (ÐŸÐµÑ€Ð²Ñ‹Ð¹)';
            }
            resetGame();
        }

        window.resetGame = function() {
            boardState = ['', '', '', '', '', '', '', '', ''];
            gameActive = true;
            currentPlayer = 'O'; 
            document.getElementById('status').innerText = `Ð¥Ð¾Ð´: ${currentPlayer}`;
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.innerText = '';
                cell.classList.remove('x', 'o');
            });

            if(gameMode === 'pve' && aiSymbol === 'O') {
                setTimeout(aiMove, 500);
            }
        }

        window.makeMove = function(index) {
            if(boardState[index] !== '' || !gameActive) return;
            if(gameMode === 'pve' && currentPlayer !== playerSymbol) return; 

            updateBoard(index, currentPlayer);
            
            if(checkWin()) {
                document.getElementById('status').innerText = `ÐŸÐ¾Ð±ÐµÐ´Ð°: ${currentPlayer}!`;
                gameActive = false;
                
                // Ð•Ð¡Ð›Ð˜ ÐŸÐžÐ‘Ð•Ð”Ð˜Ð› Ð§Ð•Ð›ÐžÐ’Ð•Ðš - Ð¡ÐžÐ¥Ð ÐÐÐ¯Ð•Ðœ Ð’ Ð‘ÐÐ—Ð£
                if(gameMode === 'pve' && currentPlayer === playerSymbol) {
                    saveWinToDB();
                }
                return;
            }
            if(boardState.every(cell => cell !== '')) {
                document.getElementById('status').innerText = "ÐÐ¸Ñ‡ÑŒÑ!";
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            document.getElementById('status').innerText = `Ð¥Ð¾Ð´: ${currentPlayer}`;

            if(gameMode === 'pve' && currentPlayer === aiSymbol) {
                setTimeout(aiMove, 600);
            }
        }

        function updateBoard(index, player) {
            boardState[index] = player;
            const cell = document.querySelectorAll('.cell')[index];
            cell.innerText = player;
            cell.classList.add(player.toLowerCase());
        }

        function aiMove() {
            if(!gameActive) return;
            let move = findBestMove(aiSymbol);
            if(move === -1) move = findBestMove(playerSymbol);
            if(move === -1 && boardState[4] === '') move = 4;
            if(move === -1) {
                let available = boardState.map((v, i) => v === '' ? i : null).filter(v => v !== null);
                move = available[Math.floor(Math.random() * available.length)];
            }
            updateBoard(move, aiSymbol);
            
            if(checkWin()) {
                document.getElementById('status').innerText = "Ð˜Ð˜ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ð» ðŸ¤–";
                gameActive = false;
                return;
            }
            if(boardState.every(cell => cell !== '')) {
                document.getElementById('status').innerText = "ÐÐ¸Ñ‡ÑŒÑ!";
                gameActive = false;
                return;
            }
            currentPlayer = playerSymbol;
            document.getElementById('status').innerText = `Ð¥Ð¾Ð´: ${currentPlayer}`;
        }

        function findBestMove(symbol) {
            const wins = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
            for(let combo of wins) {
                const [a, b, c] = combo;
                if(boardState[a] === symbol && boardState[b] === symbol && boardState[c] === '') return c;
                if(boardState[a] === symbol && boardState[c] === symbol && boardState[b] === '') return b;
                if(boardState[b] === symbol && boardState[c] === symbol && boardState[a] === '') return a;
            }
            return -1;
        }

        function checkWin() {
            const wins = [[0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6]];
            return wins.some(combo => {
                return boardState[combo[0]] !== '' &&
                       boardState[combo[0]] === boardState[combo[1]] &&
                       boardState[combo[1]] === boardState[combo[2]];
            });
        }

        // ÐœÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»ÐµÐµÑ€ (Ñ„ÐµÐ¹ÐºÐ¾Ð²Ñ‹Ð¹ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾, Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ»Ð¾Ð¶Ð½ÐµÐµ)
        window.openMultiplayerModal = function() { document.getElementById('multi-modal').style.display = 'flex'; }
        window.closeModal = function() { document.getElementById('multi-modal').style.display = 'none'; }
        window.copyLink = function() { navigator.clipboard.writeText(window.location.href); alert("Ð¡ÑÑ‹Ð»ÐºÐ° ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°!"); closeModal(); setMode('pvp'); }
        window.startAutoMatch = function() {
            const btn = event.target; btn.innerText = "ÐŸÐ¾Ð¸ÑÐº...";
            setTimeout(() => { btn.innerText = "Ð¡Ð¾Ð¿ÐµÑ€Ð½Ð¸Ðº: Bot_V3"; setTimeout(() => { closeModal(); setMode('pve'); aiSymbol = 'O'; playerSymbol = 'X'; document.getElementById('player-side').innerText = "X (Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹)"; resetGame(); }, 1000); }, 2000);
        }
    </script>
