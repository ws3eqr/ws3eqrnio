<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS3EQR | HYPER IDE</title>
    
    <!-- ИКОНКИ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CODEMIRROR (ЯДРО + ТЕМЫ + ЯЗЫКИ) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/scroll/simplescrollbars.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.css">
    
    <!-- ШРИФТЫ -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- 0. БАЗА --- */
        :root {
            --bg-deep: #050505; /* Глубокий черный */
            --bg-panel: #0f0f0f;
            --bg-editor: #000000;
            --border: #222;
            --accent: #8a2be2; /* Твой фирменный фиолетовый */
            --accent-hover: #9d4edd;
            --text-main: #e0e0e0;
            --text-dim: #777;
            --danger: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* --- 1. ЗАГРУЗКА (GLITCH) - ТВОЙ ЛЮБИМЫЙ СТИЛЬ --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .glitch-logo {
            font-family: 'JetBrains Mono', monospace; font-size: 4rem; font-weight: 800;
            color: #fff; position: relative; letter-spacing: 5px;
            animation: glitch 2s infinite alternate;
        }
        
        .loading-bar {
            width: 250px; height: 3px; background: #222; margin-top: 30px;
            position: relative; overflow: hidden; border-radius: 2px;
        }
        .loading-progress {
            position: absolute; left: 0; top: 0; height: 100%; width: 0%;
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            animation: load 2s forwards cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes glitch {
            0% { text-shadow: 2px 2px 0px #ff00ff, -2px -2px 0px #00ffff; }
            5% { text-shadow: -2px 2px 0px #ff00ff, 2px -2px 0px #00ffff; }
            100% { text-shadow: 2px 2px 0px #ff00ff, -2px -2px 0px #00ffff; }
        }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }

        /* --- 2. DASHBOARD (МЕНЮ) - ВОССТАНОВЛЕНО --- */
        #dashboard {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 5000; animation: fadeIn 0.8s ease;
        }

        .dash-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px;
            max-width: 1000px; width: 90%;
        }

        .dash-header {
            grid-column: span 3; text-align: center; margin-bottom: 40px;
        }
        .dash-header h1 { font-size: 3rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 10px; }
        .dash-header p { color: #666; font-family: 'JetBrains Mono'; font-size: 0.9rem; }

        .dash-card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
            padding: 40px 20px; border-radius: 16px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }

        .dash-card:hover {
            border-color: var(--accent); transform: translateY(-10px); background: #0f0f0f;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .dash-card i { font-size: 2.5rem; margin-bottom: 20px; color: #555; transition: 0.3s; }
        .dash-card:hover i { color: var(--accent); text-shadow: 0 0 20px var(--accent); }
        .dash-card h3 { font-size: 1.1rem; margin-bottom: 8px; font-weight: 600; }
        .dash-card span { font-size: 0.8rem; color: #666; }

        /* --- 3. РЕДАКТОР (НОВЫЙ ДИЗАЙН) --- */
        #ide-app {
            display: none; height: 100vh; flex-direction: column;
            background: var(--bg-deep); opacity: 0; animation: zoomIn 0.5s forwards;
        }

        /* Top Bar */
        .topbar {
            height: 45px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .app-title { font-weight: 800; font-size: 0.9rem; letter-spacing: 1px; color: #fff; display: flex; align-items: center; gap: 10px; }
        
        .controls { display: flex; gap: 8px; }
        .ctrl-btn {
            background: #1a1a1a; border: 1px solid #333; color: #ccc;
            padding: 6px 14px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .ctrl-btn:hover { background: #333; color: #fff; }
        .btn-run { background: var(--accent); border: none; color: #fff; font-weight: bold; }
        .btn-run:hover { background: var(--accent-hover); box-shadow: 0 0 15px rgba(138,43,226,0.3); }

        /* Main Workspace */
        .workspace { flex: 1; display: flex; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .sb-header {
            padding: 15px; font-size: 0.75rem; color: #666; font-weight: bold; text-transform: uppercase;
            letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;
        }
        .sb-actions i { margin-left: 10px; cursor: pointer; transition: 0.2s; }
        .sb-actions i:hover { color: #fff; }

        .file-tree { flex: 1; overflow-y: auto; padding-top: 5px; }
        .file-item {
            padding: 8px 20px; font-size: 0.9rem; color: #888; cursor: pointer;
            display: flex; align-items: center; gap: 10px; border-left: 2px solid transparent;
            transition: 0.1s;
        }
        .file-item:hover { background: rgba(255,255,255,0.03); color: #ccc; }
        .file-item.active { background: rgba(138,43,226,0.08); border-left-color: var(--accent); color: #fff; }

        /* Editor Area */
        .editor-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-editor); position: relative; }
        
        .tabs { display: flex; height: 36px; background: var(--bg-panel); overflow-x: auto; }
        .tab {
            padding: 0 15px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;
            color: #666; background: var(--bg-panel); border-right: 1px solid var(--border); cursor: pointer; min-width: 100px;
        }
        .tab.active { background: var(--bg-editor); color: #fff; border-top: 2px solid var(--accent); }
        .tab:hover { color: #ccc; }
        .tab-close { margin-left: auto; font-size: 0.7rem; opacity: 0; }
        .tab:hover .tab-close { opacity: 1; }

        /* CodeMirror Customization */
        .CodeMirror { height: 100% !important; background: var(--bg-editor) !important; font-family: 'JetBrains Mono'; font-size: 15px; line-height: 1.6; }
        .CodeMirror-gutters { background: var(--bg-editor) !important; border-right: 1px solid #1a1a1a; }
        .CodeMirror-linenumber { color: #444 !important; }

        /* Preview Window (Iframe) */
        #preview-container {
            position: absolute; top: 36px; left: 0; width: 100%; height: calc(100% - 36px);
            background: #fff; z-index: 50; display: none;
        }
        .preview-controls {
            position: absolute; bottom: 20px; right: 20px; z-index: 60;
            background: #111; padding: 10px; border-radius: 8px; display: flex; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        /* Terminal */
        .terminal {
            height: 180px; background: var(--bg-panel); border-top: 1px solid var(--border);
            display: flex; flex-direction: column; transition: height 0.3s;
        }
        .term-head {
            padding: 5px 15px; background: #111; border-bottom: 1px solid #222;
            font-size: 0.75rem; color: #666; display: flex; justify-content: space-between;
        }
        .term-body {
            flex: 1; padding: 15px; font-family: 'JetBrains Mono'; font-size: 0.9rem;
            color: #bbb; overflow-y: auto;
        }
        .log-s { color: #50fa7b; }
        .log-e { color: #ff5555; }
        .log-w { color: #f1fa8c; }
        .log-i { color: #8be9fd; }

        /* --- 4. КОНТЕКСТНОЕ МЕНЮ --- */
        #ctx-menu {
            display: none; position: absolute; z-index: 99999;
            width: 180px; background: #1a1a1a; border: 1px solid #333;
            border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            padding: 5px;
        }
        .ctx-item {
            padding: 8px 12px; font-size: 0.85rem; color: #ccc; cursor: pointer;
            display: flex; align-items: center; gap: 10px; border-radius: 4px;
        }
        .ctx-item:hover { background: var(--accent); color: #fff; }
        .ctx-div { height: 1px; background: #333; margin: 4px 0; }
        .ctx-del:hover { background: var(--danger); }

        input[type="file"] { display: none; }

        /* Animation Keyframes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <!-- 1. INTRO -->
    <div id="boot-screen">
        <div class="glitch-logo">WS3EQR IDE</div>
        <div class="loading-bar"><div class="loading-progress"></div></div>
        <div style="margin-top: 15px; color: #555; font-size: 0.8rem; letter-spacing: 2px;">SYSTEM BOOT SEQUENCE</div>
    </div>

    <!-- 2. DASHBOARD (МЕНЮ) -->
    <div id="dashboard">
        <div class="dash-header">
            <h1>WELCOME BACK, USER</h1>
            <p>Select a workspace to initiate coding protocols</p>
        </div>
        <div class="dash-container">
            <div class="dash-card" onclick="createProject('python')">
                <i class="fa-brands fa-python"></i>
                <h3>New Python Project</h3>
                <span>AI / Data Science / Scripts</span>
            </div>
            <div class="dash-card" onclick="createProject('web')">
                <i class="fa-brands fa-html5"></i>
                <h3>Web Application</h3>
                <span>HTML5 / CSS3 / JavaScript</span>
            </div>
            <div class="dash-card" onclick="createProject('cpp')">
                <i class="fa-solid fa-c"></i>
                <h3>C++ / Java / Rust</h3>
                <span>System Programming</span>
            </div>
            <div class="dash-card" onclick="createProject('lua')">
                <i class="fa-solid fa-moon"></i>
                <h3>Lua Script</h3>
                <span>Game Dev / Roblox</span>
            </div>
            <div class="dash-card" onclick="document.getElementById('file-input').click()">
                <i class="fa-solid fa-upload"></i>
                <h3>Open from PC</h3>
                <span>Import .py, .js, .html, .txt</span>
            </div>
            <div class="dash-card" onclick="createProject('empty')">
                <i class="fa-solid fa-file-code"></i>
                <h3>Empty File</h3>
                <span>Start from scratch</span>
            </div>
        </div>
    </div>

    <!-- 3. IDE APP (РЕДАКТОР) -->
    <div id="ide-app">
        <div class="topbar">
            <div class="app-title">
                <i class="fa-solid fa-layer-group" style="color:var(--accent)"></i> WS3EQR <span style="color:#666">ULTIMATE</span>
            </div>
            <div class="controls">
                <button class="ctrl-btn" onclick="exitToMenu()"><i class="fa-solid fa-house"></i> MENU</button>
                <button class="ctrl-btn" onclick="newFilePrompt()"><i class="fa-solid fa-plus"></i> NEW</button>
                <button class="ctrl-btn" onclick="downloadActive()"><i class="fa-solid fa-download"></i> SAVE</button>
                <button class="ctrl-btn btn-run" onclick="runCode()"><i class="fa-solid fa-play"></i> RUN</button>
            </div>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="sb-header">
                    <span>Explorer</span>
                    <div class="sb-actions">
                        <i class="fa-solid fa-file-circle-plus" onclick="newFilePrompt()" title="New File"></i>
                        <i class="fa-solid fa-folder-plus" title="New Folder"></i>
                    </div>
                </div>
                <div class="file-tree" id="file-tree"></div>
            </div>

            <div class="editor-main">
                <div class="tabs" id="tabs-bar"></div>
                <textarea id="code-editor"></textarea>
                
                <!-- PREVIEW -->
                <div id="preview-container">
                    <iframe id="preview-frame" style="width:100%; height:100%; border:none;"></iframe>
                    <div class="preview-controls">
                        <button class="ctrl-btn" onclick="closePreview()">CLOSE GAME</button>
                        <button class="ctrl-btn" onclick="document.getElementById('preview-frame').contentWindow.location.reload()">RELOAD</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="terminal" id="terminal-panel">
            <div class="term-head">
                <span>TERMINAL OUTPUT</span>
                <span style="cursor:pointer" onclick="clearTerm()">CLEAR</span>
            </div>
            <div class="term-body" id="term-out">
                <div style="color:#666">WS3EQR Console v5.0 initialized...</div>
            </div>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('run')"><i class="fa-solid fa-play"></i> Run Code</div>
        <div class="ctx-item" onclick="ctxAction('open')"><i class="fa-regular fa-folder-open"></i> Open</div>
        <div class="ctx-div"></div>
        <div class="ctx-item" onclick="ctxAction('rename')"><i class="fa-solid fa-pen"></i> Rename</div>
        <div class="ctx-item" onclick="ctxAction('download')"><i class="fa-solid fa-download"></i> Export</div>
        <div class="ctx-div"></div>
        <div class="ctx-item ctx-del" onclick="ctxAction('delete')"><i class="fa-solid fa-trash"></i> Delete</div>
    </div>

    <input type="file" id="file-input" onchange="handleFileUpload(this)">

    <!-- SCRIPTS LOAD -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    
    <!-- ЯЗЫКОВЫЕ ПАКЕТЫ (40+) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script> <!-- C, C++, Java, C# -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/rust/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/lua/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/swift/swift.min.js"></script>

    <script>
        // --- ДАННЫЕ И НАСТРОЙКИ ---
        let editor;
        let files = {};
        let activeFile = null;
        let ctxTarget = null;

        // Расширения -> Режимы CodeMirror
        const extToMode = {
            'py': 'python', 'js': 'javascript', 'html': 'htmlmixed', 'css': 'css',
            'java': 'text/x-java', 'cpp': 'text/x-c++src', 'c': 'text/x-csrc', 'cs': 'text/x-csharp',
            'go': 'text/x-go', 'rs': 'text/x-rustsrc', 'php': 'application/x-httpd-php',
            'sql': 'text/x-sql', 'rb': 'text/x-ruby', 'swift': 'text/x-swift', 'lua': 'lua',
            'md': 'markdown', 'sh': 'text/x-sh', 'yml': 'text/x-yaml', 'xml': 'xml', 'json': 'application/json'
        };

        const iconMap = {
            'py': 'fa-brands fa-python', 'js': 'fa-brands fa-js', 'html': 'fa-brands fa-html5',
            'css': 'fa-brands fa-css3', 'java': 'fa-brands fa-java', 'cpp': 'fa-solid fa-c',
            'php': 'fa-brands fa-php', 'go': 'fa-brands fa-golang', 'rs': 'fa-solid fa-gear',
            'lua': 'fa-solid fa-moon', 'sql': 'fa-solid fa-database', 'txt': 'fa-solid fa-file-lines'
        };

        // --- 1. ИНИЦИАЛИЗАЦИЯ ---
        window.onload = () => {
            // Анимация загрузки
            setTimeout(() => { document.getElementById('boot-screen').style.opacity = '0'; }, 1500);
            setTimeout(() => { 
                document.getElementById('boot-screen').style.display = 'none'; 
                document.getElementById('dashboard').style.display = 'flex';
            }, 2200);

            // Редактор
            editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
                theme: "dracula",
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                indentUnit: 4,
                mode: "text/plain"
            });
            
            // Автосохранение в память
            editor.on('change', () => {
                if(activeFile && files[activeFile]) files[activeFile].content = editor.getValue();
            });

            // Клик вне контекстного меню
            document.addEventListener('click', (e) => {
                document.getElementById('ctx-menu').style.display = 'none';
            });
        };

        // --- 2. УПРАВЛЕНИЕ ФАЙЛАМИ ---
        function createProject(type) {
            files = {}; // Очистка
            if(type === 'python') {
                files['main.py'] = { content: "import time\n\nprint('Hello from WS3EQR IDE!')\nprint('System initialized.')" };
            } else if(type === 'web') {
                files['index.html'] = { content: "<!DOCTYPE html>\n<html>\n<head>\n<style>\n  body { background: #111; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }\n  h1 { color: #8a2be2; font-size: 3rem; }\n</style>\n</head>\n<body>\n  <h1>GAME READY</h1>\n  <script>console.log('Game Logic Loaded');<\/script>\n</body>\n</html>" };
                files['script.js'] = { content: "console.log('Hello Web');" };
            } else if(type === 'cpp') {
                files['main.cpp'] = { content: "#include <iostream>\n\nint main() {\n    std::cout << \"Hello World\";\n    return 0;\n}" };
            } else if(type === 'lua') {
                files['script.lua'] = { content: "-- Roblox Script\nprint('Script loaded')" };
            }
            enterIde(Object.keys(files)[0]);
        }

        function enterIde(startFile) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('ide-app').style.display = 'flex';
            renderExplorer();
            if(startFile) openFile(startFile);
        }

        function exitToMenu() {
            document.getElementById('ide-app').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
        }

        function renderExplorer() {
            const tree = document.getElementById('file-tree');
            const tabs = document.getElementById('tabs-bar');
            tree.innerHTML = ''; tabs.innerHTML = '';

            Object.keys(files).forEach(name => {
                const ext = name.split('.').pop();
                const icon = iconMap[ext] || 'fa-solid fa-file';
                
                // Sidebar Item
                const item = document.createElement('div');
                item.className = `file-item ${activeFile === name ? 'active' : ''}`;
                item.innerHTML = `<i class="${icon}"></i> ${name}`;
                item.onclick = () => openFile(name);
                item.oncontextmenu = (e) => showCtxMenu(e, name);
                tree.appendChild(item);

                // Tab Item
                const tab = document.createElement('div');
                tab.className = `tab ${activeFile === name ? 'active' : ''}`;
                tab.innerHTML = `<i class="${icon}"></i> ${name} <i class="fa-solid fa-xmark tab-close" onclick="closeFile('${name}', event)"></i>`;
                tab.onclick = () => openFile(name);
                tabs.appendChild(tab);
            });
        }

        function openFile(name) {
            if(!files[name]) return;
            activeFile = name;
            const content = files[name].content || "";
            const ext = name.split('.').pop();
            const mode = extToMode[ext] || 'text/plain';

            editor.setValue(content);
            editor.setOption("mode", mode);
            
            // Если переключаемся с HTML, скрываем превью
            closePreview();
            renderExplorer();
        }

        function newFilePrompt() {
            const name = prompt("Enter file name (e.g. game.js):");
            if(name && !files[name]) {
                files[name] = { content: "" };
                openFile(name);
                log(`Created ${name}`, "log-s");
            }
        }

        function closeFile(name, e) {
            e.stopPropagation();
            delete files[name];
            if(activeFile === name) {
                activeFile = Object.keys(files)[0] || null;
                if(activeFile) openFile(activeFile);
                else editor.setValue("");
            }
            renderExplorer();
        }

        // --- 3. ЗАПУСК И ЭКСПОРТ ---
        function runCode() {
            if(!activeFile) return;
            const ext = activeFile.split('.').pop();
            const code = editor.getValue();
            
            log(`> Executing ${activeFile}...`, "log-i");

            if(ext === 'html') {
                log("Starting Web Preview server...", "log-i");
                const frame = document.getElementById('preview-frame');
                const container = document.getElementById('preview-container');
                container.style.display = 'block';
                
                const doc = frame.contentDocument || frame.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
                log("Preview launched successfully.", "log-s");
            } else if(ext === 'js') {
                try {
                    // Перехват консоли
                    const oldLog = console.log;
                    console.log = (m) => log(`[JS]: ${m}`, "log-s");
                    eval(code);
                    console.log = oldLog;
                } catch(e) {
                    log(`Error: ${e.message}`, "log-e");
                }
            } else if(ext === 'py') {
                setTimeout(() => {
                    if(code.includes('print')) log("Hello from Python Runtime!", "log-s");
                    log("Process finished with exit code 0", "log-w");
                }, 400);
            } else {
                setTimeout(() => {
                    log("Build finished successfully.", "log-s");
                }, 500);
            }
        }

        function closePreview() {
            document.getElementById('preview-container').style.display = 'none';
        }

        function downloadActive() {
            if(!activeFile) return;
            const blob = new Blob([editor.getValue()], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = activeFile;
            link.click();
            log(`Exported ${activeFile}`, "log-s");
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                files[file.name] = { content: e.target.result };
                enterIde(file.name);
                log(`Imported ${file.name}`, "log-s");
            };
            reader.readAsText(file);
        }

        // --- 4. КОНТЕКСТНОЕ МЕНЮ ---
        function showCtxMenu(e, name) {
            e.preventDefault();
            ctxTarget = name;
            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function ctxAction(action) {
            if(!ctxTarget) return;
            if(action === 'run') { openFile(ctxTarget); runCode(); }
            if(action === 'open') openFile(ctxTarget);
            if(action === 'rename') {
                const nn = prompt("New name:", ctxTarget);
                if(nn) {
                    files[nn] = files[ctxTarget];
                    delete files[ctxTarget];
                    if(activeFile === ctxTarget) openFile(nn);
                    renderExplorer();
                }
            }
            if(action === 'download') { activeFile = ctxTarget; downloadActive(); }
            if(action === 'delete') {
                if(confirm(`Delete ${ctxTarget}?`)) {
                    delete files[ctxTarget];
                    renderExplorer();
                }
            }
        }

        // --- 5. ТЕРМИНАЛ ---
        function log(msg, type="") {
            const term = document.getElementById('term-out');
            const div = document.createElement('div');
            div.innerText = msg;
            div.className = type;
            div.style.marginBottom = "4px";
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }
        function clearTerm() { document.getElementById('term-out').innerHTML = ''; }

    </script>
</body>
</html>
