<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS3EQR | GENESIS ULTIMATE OS</title>
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- 0. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (THEME ENGINE) --- */
        :root {
            --bg-dark: #050505;
            --glass-panel: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #8a2be2; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –Ω–µ–æ–Ω */
            --accent-glow: rgba(138, 43, 226, 0.5);
            --text-main: #ffffff;
            --text-dim: #888888;
            --success: #00ff88;
            --danger: #ff4444;
            --warn: #ffbb33;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        /* –°–ë–†–û–° –ò –ë–ê–ó–ê */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; cursor: none; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- 1. –ö–£–†–°–û–† –ò –ú–ò–† --- */
        #custom-cursor {
            position: fixed; top: 0; left: 0; width: 24px; height: 24px; z-index: 99999; pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="black" stroke-width="1.5"><path d="M5.5 3.21l10.8 15.6-5.6-.6-2.6 5.8-3.4-1.4 2.5-5.6H1.8z"/></svg>') no-repeat;
            filter: drop-shadow(0 0 5px var(--accent));
            transition: transform 0.05s ease-out;
        }

        /* –°–ª–æ–∏ –∏–≥—Ä—ã */
        #world-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        #weather-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #lighting-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; mix-blend-mode: multiply; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }

        /* --- 2. –ò–ù–¢–ï–†–§–ï–ô–° (OS STYLE) --- */
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(10, 10, 10, 0.8); border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; pointer-events: all; z-index: 1000;
        }
        .os-logo { font-weight: 900; letter-spacing: 1px; color: var(--text-main); font-size: 0.9rem; }
        .os-logo span { color: var(--accent); }
        .os-stats { display: flex; gap: 20px; font-family: var(--font-code); font-size: 0.75rem; color: var(--text-dim); }
        .stat-item i { color: var(--accent); margin-right: 5px; }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é (–ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤) */
        .toolbar {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px 10px; display: flex; flex-direction: column; gap: 15px;
            backdrop-filter: blur(20px); pointer-events: all;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .toolbar:hover { border-color: var(--accent); transform: translateY(-50%) scale(1.02); }
        
        .tool-btn {
            width: 40px; height: 40px; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.05); color: #fff; font-size: 1.2rem;
            cursor: none; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .tool-btn:hover { background: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .tool-btn::after {
            content: attr(data-tooltip); position: absolute; left: 55px;
            background: #111; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem;
            opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; border: 1px solid #333;
        }
        .tool-btn:hover::after { opacity: 1; left: 60px; }

        /* –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–°–∫—Ä—ã—Ç–æ) */
        .window-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 700px; height: 500px; background: #0a0a0a;
            border: 1px solid var(--glass-border); border-radius: 12px;
            display: none; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8); opacity: 0; transition: 0.3s; pointer-events: all;
            z-index: 2000;
        }
        .window-panel.open { transform: translate(-50%, -50%) scale(1); opacity: 1; display: flex; }
        
        .win-header {
            height: 40px; background: #111; border-bottom: 1px solid #222;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .win-title { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: #888; }
        .win-close { color: var(--danger); font-size: 1rem; cursor: none; }
        
        .win-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* –°–µ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .setting-item { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #222; }
        .setting-item h4 { color: var(--accent); margin-bottom: 5px; font-size: 0.85rem; }
        .setting-item p { color: #555; font-size: 0.7rem; margin-bottom: 10px; }
        
        /* –°–ª–∞–π–¥–µ—Ä—ã –∏ —á–µ–∫–±–æ–∫—Å—ã */
        input[type=range] { width: 100%; accent-color: var(--accent); }
        .checkbox-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—É—â–µ—Å—Ç–≤–∞ (–ü—Ä–∏ –∫–ª–∏–∫–µ) */
        #entity-card {
            position: absolute; right: 20px; top: 60px; width: 300px;
            background: rgba(15, 15, 15, 0.9); border: 1px solid var(--accent);
            border-radius: 12px; padding: 20px; backdrop-filter: blur(15px);
            display: none; pointer-events: all; animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .card-avatar { width: 50px; height: 50px; background: #222; border-radius: 50%; border: 2px solid #fff; }
        .card-name { font-weight: bold; font-size: 1.1rem; }
        .card-role { font-size: 0.75rem; color: var(--accent); text-transform: uppercase; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #aaa; }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ü–ö–ú) */
        #ctx-menu {
            position: absolute; background: #1a1a1a; border: 1px solid #333;
            width: 180px; border-radius: 6px; padding: 5px; display: none; z-index: 5000; pointer-events: all;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .ctx-item {
            padding: 8px 12px; font-size: 0.85rem; color: #ccc; border-radius: 4px; display: flex; gap: 10px; align-items: center;
        }
        .ctx-item:hover { background: var(--accent); color: #fff; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π */
        .bubble {
            position: absolute; background: #fff; color: #000; padding: 5px 10px;
            border-radius: 10px; font-size: 0.75rem; font-weight: bold; pointer-events: none;
            transform: translate(-50%, -100%); white-space: nowrap; opacity: 0; transition: opacity 0.3s; z-index: 50;
        }
        .bubble::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            border-width: 5px; border-style: solid; border-color: #fff transparent transparent transparent;
        }

    </style>
</head>
<body>

    <!-- 0. –°–ò–°–¢–ï–ú–ù–´–ï –°–õ–û–ò -->
    <div id="custom-cursor"></div>
    <div id="lighting-layer"></div> <!-- –°–ª–æ–π –¥–ª—è –ù–æ—á–∏ -->
    
    <!-- 1. –ò–ì–†–û–í–û–ô –ú–ò–† -->
    <canvas id="world-layer"></canvas>
    <canvas id="weather-canvas"></canvas>

    <!-- 2. –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="ui-layer">
        
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-bar">
            <div class="os-logo">WS3EQR <span>GENESIS</span></div>
            <div class="os-stats">
                <div class="stat-item"><i class="fa-solid fa-users"></i> POP: <span id="ui-pop">0</span></div>
                <div class="stat-item"><i class="fa-solid fa-clock"></i> TIME: <span id="ui-time">12:00</span></div>
                <div class="stat-item"><i class="fa-solid fa-cloud"></i> WEATHER: <span id="ui-weather">CLEAR</span></div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="toolbar">
            <button class="tool-btn" onclick="Game.spawn('stickman')" data-tooltip="Spawn Unit"><i class="fa-solid fa-person"></i></button>
            <button class="tool-btn" onclick="Game.spawn('food')" data-tooltip="Drop Food"><i class="fa-solid fa-burger"></i></button>
            <button class="tool-btn" onclick="Game.spawn('wood')" data-tooltip="Resources"><i class="fa-solid fa-cubes"></i></button>
            <button class="tool-btn" onclick="Game.toggleRain()" data-tooltip="Toggle Rain"><i class="fa-solid fa-cloud-rain"></i></button>
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 5px 0;"></div>
            <button class="tool-btn" onclick="UI.toggleSettings()" data-tooltip="Settings"><i class="fa-solid fa-gear"></i></button>
            <button class="tool-btn" style="color:var(--danger)" onclick="Game.nuke()" data-tooltip="NUKE"><i class="fa-solid fa-radiation"></i></button>
        </div>

        <!-- –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="window-panel" id="settings-win">
            <div class="win-header">
                <span class="win-title">System Configuration</span>
                <span class="win-close" onclick="UI.toggleSettings()">‚úñ</span>
            </div>
            <div class="win-content">
                <div class="settings-grid">
                    <div class="setting-item">
                        <h4>Gravity Force</h4>
                        <p>Controls global physics weight.</p>
                        <input type="range" min="0" max="20" value="10" id="set-grav">
                    </div>
                    <div class="setting-item">
                        <h4>AI Complexity</h4>
                        <p>Brain processing power.</p>
                        <div class="checkbox-row">
                            <span>Smart Thinking</span>
                            <input type="checkbox" checked id="set-smart">
                        </div>
                    </div>
                    <div class="setting-item">
                        <h4>Interactions</h4>
                        <div class="checkbox-row">
                            <span>Mouse Theft</span>
                            <input type="checkbox" checked id="set-steal">
                        </div>
                        <div class="checkbox-row">
                            <span>Tribe Wars</span>
                            <input type="checkbox" id="set-war">
                        </div>
                    </div>
                </div>
                <button class="tool-btn" style="width: 100%; margin-top: 20px; font-size: 0.9rem; border-radius: 6px;" onclick="Game.save()">SAVE WORLD STATE</button>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ –∫–∞—Ä—Ç–æ—á–∫–∞ (–°–∫—Ä—ã—Ç–∞) -->
        <div id="entity-card">
            <div class="card-header">
                <div class="card-avatar" id="card-color"></div>
                <div>
                    <div class="card-name" id="card-name">Unit-X</div>
                    <div class="card-role" id="card-state">IDLE</div>
                </div>
            </div>
            <div class="stat-row"><span>Health</span><span id="txt-hp">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:var(--danger); width:100%" id="bar-hp"></div></div>
            
            <div class="stat-row"><span>Hunger</span><span id="txt-hunger">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:orange; width:100%" id="bar-hunger"></div></div>

            <div class="stat-row"><span>Energy</span><span id="txt-energy">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:var(--success); width:100%" id="bar-energy"></div></div>
            
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px; font-size:0.8rem; color:#888;">
                <i class="fa-solid fa-bullseye"></i> Goal: <span id="card-goal" style="color:#fff">None</span>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
        <div id="ctx-menu">
            <div class="ctx-item" onclick="Game.ctxAction('inspect')"><i class="fa-solid fa-eye"></i> Inspect</div>
            <div class="ctx-item" onclick="Game.ctxAction('feed')"><i class="fa-solid fa-burger"></i> Feed</div>
            <div class="ctx-item" onclick="Game.ctxAction('kill')"><i class="fa-solid fa-skull"></i> Terminate</div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—É–∑—ã—Ä—å–∫–æ–≤ —Ä–µ—á–∏ -->
        <div id="bubbles-layer"></div>

    </div>
<script>
        // --- –ß–ê–°–¢–¨ 2: –Ø–î–†–û –°–ò–ú–£–õ–Ø–¶–ò–ò –ò –ö–õ–ê–°–°–´ ---

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∞–Ω–≤–∞—Å–∞
        const CANVAS = document.getElementById('world-layer');
        const CTX = CANVAS.getContext('2d');
        const W_CANVAS = document.getElementById('weather-canvas');
        const W_CTX = W_CANVAS.getContext('2d');
        const LIGHT = document.getElementById('lighting-layer'); // –°–ª–æ–π —Å–≤–µ—Ç–∞ (–¥–ª—è –Ω–æ—á–∏)
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let WIDTH, HEIGHT;
        let MOUSE = { x: 0, y: 0, down: false, holding: null };
        let TARGET_FPS = 60;
        let FRAME = 0;

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∏—Ä–∞
        const WORLD = {
            gravity: 0.5,
            ground: 0,
            friction: 0.9,
            time: 800, // –í—Ä–µ–º—è (0-2400)
            rain: false,
            wind: 0,
            
            // –°–ø–∏—Å–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤
            units: [],
            items: [],
            particles: [],
            structures: [],
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏–∑–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ UI)
            settings: {
                stealMouse: true,
                smartAI: true,
                warMode: false
            }
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        const Rnd = (min, max) => Math.random() * (max - min) + min;
        const Dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
        const Clamp = (val, min, max) => Math.min(Math.max(val, min), max);

        // --- –ö–õ–ê–°–°: –°–£–©–ù–û–°–¢–¨ (STICKMAN) ---
        class Entity {
            constructor(x, y, loadData = null) {
                if (loadData) { Object.assign(this, loadData); return; }

                this.id = Math.random().toString(36).substr(2, 9);
                this.x = x || Rnd(50, WIDTH - 50);
                this.y = y || WORLD.ground - 100;
                this.vx = 0;
                this.vy = 0;
                this.size = 40;
                
                // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                this.tribe = ['#ff4444', '#00ff88', '#8be9fd'][Math.floor(Math.random() * 3)]; // –ö—Ä–∞—Å–Ω—ã–π, –ó–µ–ª–µ–Ω—ã–π, –°–∏–Ω–∏–π
                this.hp = 100;
                this.maxHp = 100;
                this.hunger = 100;
                this.energy = 100;
                this.inventory = { wood: 0, food: 0, weapon: false };
                
                // –ú–æ–∑–≥
                this.state = 'idle'; // idle, move, sleep, build, panic, steal, attack, dance
                this.target = null;  // –¶–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è (–æ–±—ä–µ–∫—Ç –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
                this.goal = 'Waiting...'; // –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏
                this.isGrabbed = false; // –°—Ö–≤–∞—á–µ–Ω –º—ã—à–∫–æ–π
                this.holdingMouse = false; // –£–∫—Ä–∞–ª –∫—É—Ä—Å–æ—Ä
                
                // –í–∏–∑—É–∞–ª
                this.frame = Rnd(0, 100);
                this.dir = 1; // 1 = –≤–ø—Ä–∞–≤–æ, -1 = –≤–ª–µ–≤–æ
                this.chatTimer = 0;
            }

            // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —é–Ω–∏—Ç–∞
            update() {
                if (this.hp <= 0) return this.die();

                // 1. –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ —Ç–∞–π–º–µ—Ä—ã
                this.hunger -= 0.03;
                this.energy -= 0.02;
                if (this.chatTimer > 0) this.chatTimer--;

                // –ï—Å–ª–∏ —Å—Ö–≤–∞—á–µ–Ω –º—ã—à–∫–æ–π - —Ñ–∏–∑–∏–∫–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
                if (this.isGrabbed) {
                    this.x = MOUSE.x;
                    this.y = MOUSE.y;
                    this.vx = 0; this.vy = 0;
                    this.state = 'panic';
                    if (this.holdingMouse) this.dropMouse(); // –ë—Ä–æ—Å–∞–µ—Ç –º—ã—à—å –µ—Å–ª–∏ –µ–≥–æ —Å—Ö–≤–∞—Ç–∏–ª–∏
                    return;
                }

                // 2. –ò–ò (–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π)
                if (FRAME % 10 === 0) this.think(); 

                // 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
                this.act();

                // 4. –§–∏–∑–∏–∫–∞
                this.applyPhysics();
            }

            // –õ–æ–≥–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è (Brain)
            think() {
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –°–æ–Ω (–µ—Å–ª–∏ –Ω–æ—á—å –∏–ª–∏ –Ω–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏)
                const isNight = WORLD.time > 2000 || WORLD.time < 600;
                if ((this.energy < 20 || (isNight && this.energy < 90)) && this.state !== 'panic') {
                    this.setGoal('sleep', null, 'Zzz...');
                    return;
                }

                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ì–æ–ª–æ–¥
                if (this.hunger < 50) {
                    const food = this.findNearest('food');
                    if (food) {
                        this.setGoal('eat', food, 'Searching Food');
                    } else {
                        // –ï—Å–ª–∏ –µ–¥—ã –Ω–µ—Ç, –ø–∞–Ω–∏–∫—É–µ–º –∏–ª–∏ –ø—Ä–æ—Å–∏–º
                        if (this.hunger < 20) this.say("NEED FOOD!");
                        this.setGoal('wander', null, 'Starving');
                    }
                    return;
                }

                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –í–æ–π–Ω–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
                if (WORLD.settings.warMode) {
                    const enemy = this.findEnemy();
                    if (enemy) {
                        this.setGoal('attack', enemy, 'ATTACKING!');
                        return;
                    }
                }

                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –°—Ç—Ä–æ–π–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Å—É—Ä—Å—ã)
                if (this.inventory.wood >= 3) {
                    this.setGoal('build', null, 'Building Base');
                    return;
                }

                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5: –°–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
                const wood = this.findNearest('wood');
                if (wood && Rnd(0, 1) < 0.3) { // 30% —à–∞–Ω—Å –ø–æ–π—Ç–∏ –∑–∞ –¥–µ—Ä–µ–≤–æ–º
                    this.setGoal('gather', wood, 'Getting Wood');
                    return;
                }

                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 6: –í–æ—Ä–æ–≤—Å—Ç–≤–æ –º—ã—à–∏ (–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞)
                if (WORLD.settings.stealMouse && !this.holdingMouse && !MOUSE.holding && Rnd(0, 1) < 0.005) {
                    this.setGoal('steal_mouse', {x: MOUSE.x, y: MOUSE.y}, 'Hehe...');
                    return;
                }

                // –ï—Å–ª–∏ –¥–µ–ª–∞—Ç—å –Ω–µ—á–µ–≥–æ
                if (this.state === 'idle' || this.state === 'sleep') {
                    if (Rnd(0, 1) < 0.05) this.setGoal('wander', null, 'Exploring');
                    else if (Rnd(0, 1) < 0.01) this.setGoal('dance', null, 'Vibing');
                }
            }

            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            act() {
                switch (this.state) {
                    case 'move':
                    case 'gather':
                    case 'eat':
                    case 'attack':
                    case 'steal_mouse':
                        if (this.target) {
                            // –ï—Å–ª–∏ —Ü–µ–ª—å —ç—Ç–æ –º—ã—à–∫–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                            if(this.state === 'steal_mouse' && !this.holdingMouse) {
                                this.target = {x: MOUSE.x, y: MOUSE.y};
                            }
                            this.moveTo(this.target);
                            this.interactWithTarget();
                        } else {
                            this.state = 'idle';
                        }
                        break;
                    
                    case 'wander':
                        if (Rnd(0,1) < 0.05) this.vx = Rnd(-2, 2);
                        if (this.x < 50) this.vx = 2;
                        if (this.x > WIDTH - 50) this.vx = -2;
                        break;

                    case 'sleep':
                        this.vx = 0;
                        this.energy += 0.05;
                        if (this.energy >= 100) {
                            this.energy = 100;
                            this.state = 'idle';
                            this.say("Good morning!");
                        }
                        break;
                    
                    case 'dance':
                        this.vx = 0;
                        if (Rnd(0,1) < 0.02) this.state = 'idle'; // –ó–∞–∫–æ–Ω—á–∏—Ç—å —Ç–∞–Ω–µ—Ü
                        break;
                }

                // –ï—Å–ª–∏ –¥–µ—Ä–∂–∏—Ç –º—ã—à—å - –∫—É—Ä—Å–æ—Ä –ø—Ä–∏–∫–ª–µ–µ–Ω –∫ –Ω–µ–º—É
                if (this.holdingMouse) {
                    const cursorEl = document.getElementById('custom-cursor');
                    cursorEl.style.transform = `translate(${this.x + 10}px, ${this.y + 10}px) rotate(180deg)`;
                    
                    // –ò–Ω–æ–≥–¥–∞ –±—Ä–æ—Å–∞–µ—Ç
                    if (Rnd(0, 1) < 0.01) this.dropMouse();
                }
            }

            moveTo(t) {
                const dx = t.x - this.x;
                const dist = Math.abs(dx);
                
                if (dist > 10) {
                    this.vx += Math.sign(dx) * 0.5;
                    this.dir = Math.sign(dx);
                    // –ü—Ä—ã–∂–æ–∫
                    if (this.y === WORLD.ground && Rnd(0,1) < 0.02) this.vy = -10; 
                } else {
                    this.vx *= 0.5; // –¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ —É —Ü–µ–ª–∏
                }
                
                // –õ–∏–º–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
                this.vx = Clamp(this.vx, -4, 4);
            }

            interactWithTarget() {
                const dist = Dist(this, this.target);
                if (dist > 30) return;

                if (this.state === 'eat') {
                    this.hunger = 100;
                    this.say("Yummy!");
                    Game.removeObj(this.target, 'items');
                    Game.spawnParticles(this.x, this.y, '#0f0', 5);
                    this.state = 'idle';
                }
                else if (this.state === 'gather') {
                    this.inventory.wood++;
                    this.say("+1 Wood");
                    Game.removeObj(this.target, 'items');
                    this.state = 'idle';
                }
                else if (this.state === 'attack') {
                    this.target.hp -= 1;
                    this.target.vx = Math.sign(this.target.x - this.x) * 5; // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ
                    this.target.vy = -5;
                    Game.spawnParticles(this.target.x, this.target.y, '#f00', 2);
                    if(this.target.hp <= 0) this.say("Victory!");
                }
                else if (this.state === 'steal_mouse' && !this.holdingMouse) {
                    this.holdingMouse = true;
                    this.say("Gotcha!");
                    document.getElementById('custom-cursor').style.filter = "invert(1)"; // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞—Ö–≤–∞—Ç–∞
                }
            }

            applyPhysics() {
                this.vy += WORLD.gravity;
                this.x += this.vx;
                this.y += this.vy;

                // –ü–æ–ª
                if (this.y > WORLD.ground) {
                    this.y = WORLD.ground;
                    this.vy = 0;
                    this.vx *= WORLD.friction;
                }

                // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
                WORLD.structures.forEach(s => {
                    if (this.x > s.x && this.x < s.x + s.w && 
                        this.y >= s.y - 5 && this.y <= s.y + 10 && this.vy >= 0) {
                        this.y = s.y;
                        this.vy = 0;
                        this.vx *= WORLD.friction;
                    }
                });

                // –°—Ç–µ–Ω—ã
                if (this.x < 0) { this.x = 0; this.vx *= -1; }
                if (this.x > WIDTH) { this.x = WIDTH; this.vx *= -1; }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            setGoal(state, target, text) {
                this.state = state;
                this.target = target;
                this.goal = text;
            }

            findNearest(type) {
                let minDst = Infinity;
                let res = null;
                WORLD.items.forEach(i => {
                    if (i.type === type) {
                        const d = Dist(this, i);
                        if (d < minDst) { minDst = d; res = i; }
                    }
                });
                return res;
            }

            findEnemy() {
                return WORLD.units.find(u => u !== this && u.tribe !== this.tribe && u.hp > 0);
            }

            dropMouse() {
                this.holdingMouse = false;
                this.say("Boring...");
                document.getElementById('custom-cursor').style.transform = `translate(${MOUSE.x}px, ${MOUSE.y}px)`;
                document.getElementById('custom-cursor').style.filter = "none";
            }

            say(text) {
                // –°–æ–∑–¥–∞–µ–º HTML –ø—É–∑—ã—Ä—å (Bubble)
                const b = document.createElement('div');
                b.className = 'bubble';
                b.innerText = text;
                b.style.left = this.x + 'px';
                b.style.top = (this.y - 50) + 'px';
                document.getElementById('bubbles-layer').appendChild(b);
                
                // –ê–Ω–∏–º–∞—Ü–∏—è
                setTimeout(() => b.style.opacity = 1, 10);
                setTimeout(() => {
                    b.style.opacity = 0;
                    setTimeout(() => b.remove(), 300);
                }, 2000);
            }

            die() {
                Game.spawnParticles(this.x, this.y, '#fff', 20);
                Game.removeObj(this, 'units');
            }

            draw() {
                CTX.save();
                CTX.translate(this.x, this.y);

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–ª–∞ (–°—Ç–∏–ª—å: –ù–µ–æ–Ω –°—Ç–∏–∫–º–∞–Ω)
                CTX.strokeStyle = this.tribe;
                CTX.lineWidth = 3;
                CTX.lineCap = 'round';
                CTX.shadowBlur = 10;
                CTX.shadowColor = this.tribe;

                // –ù–æ–≥–∏ (–ê–Ω–∏–º–∞—Ü–∏—è —Ö–æ–¥—å–±—ã)
                let legAnim = (Math.abs(this.vx) > 0.1) ? Math.sin(FRAME * 0.2) * 10 : 0;
                
                // –ü–æ–∑–∞: –°–æ–Ω
                if (this.state === 'sleep') {
                    CTX.rotate(Math.PI / 2);
                    legAnim = 0;
                }

                // –†–∏—Å—É–µ–º —Å–∫–µ–ª–µ—Ç
                CTX.beginPath();
                // –ù–æ–≥–∏
                CTX.moveTo(0, -20); CTX.lineTo(-10 + legAnim, 0); 
                CTX.moveTo(0, -20); CTX.lineTo(10 - legAnim, 0);
                // –¢–æ—Ä—Å
                CTX.moveTo(0, -20); CTX.lineTo(0, -50);
                // –†—É–∫–∏
                let armAnim = legAnim;
                if(this.state === 'attack') armAnim = -20; // –ü–æ–¥–Ω—è—Ç—ã–µ —Ä—É–∫–∏
                if(this.holdingMouse) armAnim = -30; // –†—É–∫–∏ –≤–≤–µ—Ä—Ö –¥–µ—Ä–∂–∞—Ç –º—ã—à—å

                CTX.moveTo(0, -45); CTX.lineTo(-15, -30 - armAnim);
                CTX.moveTo(0, -45); CTX.lineTo(15, -30 + armAnim);
                CTX.stroke();

                // –ì–æ–ª–æ–≤–∞
                CTX.fillStyle = '#000';
                CTX.beginPath(); CTX.arc(0, -60, 10, 0, Math.PI*2); CTX.fill(); CTX.stroke();

                // –ì–ª–∞–∑–∞ (–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞)
                CTX.fillStyle = '#fff';
                if(this.state === 'attack' || this.state === 'steal_mouse') CTX.fillStyle = '#f00'; // –ó–ª—ã–µ –≥–ª–∞–∑–∞
                CTX.beginPath(); CTX.arc(this.dir * 3, -62, 2, 0, Math.PI*2); CTX.fill();

                // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —Ä—É–∫–∞—Ö
                if(this.state === 'build') {
                    CTX.fillStyle = '#aaa';
                    CTX.fillRect(15, -45, 12, 6); // –ú–æ–ª–æ—Ç–æ–∫
                }

                // –ü–æ–ª–æ—Å–∫–∞ HP (–µ—Å–ª–∏ —Ä–∞–Ω–µ–Ω)
                if(this.hp < 100) {
                    CTX.fillStyle = '#333'; CTX.fillRect(-15, -80, 30, 4);
                    CTX.fillStyle = '#f00'; CTX.fillRect(-15, -80, 30 * (this.hp/100), 4);
                }

                CTX.restore();
            }
        }

        // --- –ö–õ–ê–°–°: –ü–†–ï–î–ú–ï–¢ (ITEM) ---
        class Item {
            constructor(type, x, y) {
                this.type = type; // food, wood
                this.x = x;
                this.y = y;
                this.color = type === 'food' ? '#ffaa00' : '#8B4513';
                this.icon = type === 'food' ? 'üçî' : 'ü™µ';
            }
            draw() {
                CTX.fillStyle = this.color;
                CTX.shadowBlur = 0;
                CTX.beginPath(); CTX.arc(this.x, this.y - 5, 5, 0, Math.PI*2); CTX.fill();
                CTX.font = "12px Arial"; CTX.textAlign = "center";
                CTX.fillText(this.icon, this.x, this.y - 10);
            }
        }

        // --- –ö–õ–ê–°–°: –ß–ê–°–¢–ò–¶–ê (PARTICLE) ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
                this.color = color;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.02;
                this.vy += 0.2; // Gravity
            }
            draw() {
                CTX.globalAlpha = this.life;
                CTX.fillStyle = this.color;
                CTX.fillRect(this.x, this.y, 4, 4);
                CTX.globalAlpha = 1;
            }
        }

        // --- –ö–õ–ê–°–°: –°–¢–†–£–ö–¢–£–†–ê (PLATFORM) ---
        class Structure {
            constructor(x, y, w) {
                this.x = x; this.y = y; this.w = w; this.h = 10;
            }
            draw() {
                CTX.fillStyle = '#333';
                CTX.fillRect(this.x, this.y, this.w, this.h);
                CTX.strokeStyle = '#8a2be2';
                CTX.lineWidth = 1;
                CTX.strokeRect(this.x, this.y, this.w, this.h);
            }
        }

    </script>
    // --- –ß–ê–°–¢–¨ 3: –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö –ò UI ---

        const Game = {
            init: () => {
                Game.resize();
                window.addEventListener('resize', Game.resize);

                // –°–ª—É—à–∞—Ç–µ–ª–∏ –º—ã—à–∏
                document.addEventListener('mousemove', e => {
                    MOUSE.x = e.clientX;
                    MOUSE.y = e.clientY;
                    // –î–≤–∏–∂–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫—É—Ä—Å–æ—Ä–∞
                    const c = document.getElementById('custom-cursor');
                    if (c) c.style.transform = `translate(${MOUSE.x}px, ${MOUSE.y}px)`;
                });

                document.addEventListener('mousedown', e => {
                    MOUSE.down = true;
                    // –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞ –∫—É—Ä—Å–æ—Ä–∞
                    const c = document.getElementById('custom-cursor');
                    if (c) c.style.transform += " scale(0.8)";
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —é–Ω–∏—Ç–∞–º
                    UI.handleWorldClick(e.clientX, e.clientY);
                });

                document.addEventListener('mouseup', () => {
                    MOUSE.down = false;
                    const c = document.getElementById('custom-cursor');
                    if (c) c.style.transform = c.style.transform.replace(" scale(0.8)", "");
                    
                    // –û—Ç–ø—É—Å–∫–∞–µ–º —é–Ω–∏—Ç–æ–≤
                    WORLD.units.forEach(u => u.isGrabbed = false);
                });

                // –°–ø–∞–≤–Ω –ø–µ—Ä–≤—ã—Ö —é–Ω–∏—Ç–æ–≤
                for(let i=0; i<3; i++) Game.spawn('stickman');
                
                // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
                Game.loop();
            },

            resize: () => {
                WIDTH = window.innerWidth;
                HEIGHT = window.innerHeight;
                CANVAS.width = WIDTH; CANVAS.height = HEIGHT;
                W_CANVAS.width = WIDTH; W_CANVAS.height = HEIGHT;
                WORLD.ground = HEIGHT - 50;
            },

            // –ì–õ–ê–í–ù–´–ô –ò–ì–†–û–í–û–ô –¶–ò–ö–õ
            loop: () => {
                CTX.clearRect(0, 0, WIDTH, HEIGHT);
                W_CTX.clearRect(0, 0, WIDTH, HEIGHT);

                // 1. –í—Ä–µ–º—è –∏ –°–≤–µ—Ç
                Game.updateTime();

                // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä
                WORLD.structures.forEach(s => s.draw());

                // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                WORLD.items.forEach(i => i.draw());

                // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Æ–Ω–∏—Ç–æ–≤
                WORLD.units.forEach(u => {
                    u.update();
                    u.draw();
                });

                // 5. –ß–∞—Å—Ç–∏—Ü—ã
                WORLD.particles.forEach((p, i) => {
                    p.update();
                    p.draw();
                    if(p.life <= 0) WORLD.particles.splice(i, 1);
                });

                // 6. –ü–æ–≥–æ–¥–∞
                if(WORLD.rain) Game.drawRain();

                // 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                FRAME++;
                UI.updateLoop();

                requestAnimationFrame(Game.loop);
            },

            updateTime: () => {
                WORLD.time += 0.5;
                if(WORLD.time >= 2400) WORLD.time = 0;

                // –î–µ–Ω—å / –ù–æ—á—å —Ü–∏–∫–ª
                const lightLayer = document.getElementById('lighting-layer');
                // –ù–æ—á—å —Å 20:00 –¥–æ 06:00
                if(WORLD.time > 2000 || WORLD.time < 600) {
                    lightLayer.style.backgroundColor = "rgba(0, 5, 20, 0.85)"; // –¢–µ–º–Ω–æ—Ç–∞
                } else if (WORLD.time > 600 && WORLD.time < 800) {
                    lightLayer.style.backgroundColor = "rgba(255, 100, 50, 0.2)"; // –†–∞—Å—Å–≤–µ—Ç
                } else if (WORLD.time > 1800 && WORLD.time < 2000) {
                    lightLayer.style.backgroundColor = "rgba(50, 0, 100, 0.3)"; // –ó–∞–∫–∞—Ç
                } else {
                    lightLayer.style.backgroundColor = "transparent"; // –î–µ–Ω—å
                }
            },

            spawn: (type) => {
                if(type === 'stickman') {
                    WORLD.units.push(new Entity(MOUSE.x, MOUSE.y));
                    Game.spawnParticles(MOUSE.x, MOUSE.y, '#fff', 10);
                }
                else if(type === 'food' || type === 'wood') {
                    WORLD.items.push(new Item(type, MOUSE.x || Math.random()*WIDTH, 50));
                }
            },

            spawnParticles: (x, y, color, count) => {
                for(let i=0; i<count; i++) {
                    WORLD.particles.push(new Particle(x, y, color));
                }
            },

            removeObj: (obj, listName) => {
                const list = WORLD[listName];
                const idx = list.indexOf(obj);
                if(idx > -1) list.splice(idx, 1);
            },

            drawRain: () => {
                W_CTX.strokeStyle = 'rgba(100, 150, 255, 0.3)';
                W_CTX.lineWidth = 1;
                W_CTX.beginPath();
                for(let i=0; i<100; i++) {
                    const x = Math.random() * WIDTH;
                    const y = Math.random() * HEIGHT;
                    W_CTX.moveTo(x, y);
                    W_CTX.lineTo(x - 2, y + 15);
                }
                W_CTX.stroke();
            },

            toggleRain: () => { WORLD.rain = !WORLD.rain; },

            nuke: () => {
                if(confirm("WARNING: NUKE PROTOCOL INITIATED. DESTROY ALL LIFE?")) {
                    WORLD.units.forEach(u => Game.spawnParticles(u.x, u.y, '#f00', 50));
                    WORLD.units = [];
                    WORLD.items = [];
                    WORLD.structures = [];
                    // –í—Å–ø—ã—à–∫–∞
                    const flash = document.createElement('div');
                    flash.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:99999;transition:opacity 2s;";
                    document.body.appendChild(flash);
                    setTimeout(() => { flash.style.opacity = 0; setTimeout(()=>flash.remove(), 2000); }, 50);
                }
            },

            save: () => {
                alert("World State Saved to LocalStorage (Simulation)");
            },

            // –î–µ–π—Å—Ç–≤–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            ctxAction: (action) => {
                if(!UI.selectedUnit) return;
                const u = UI.selectedUnit;
                
                if(action === 'kill') u.die();
                if(action === 'feed') { u.hunger = 100; u.say("Thanks!"); }
                if(action === 'inspect') {
                    // Force update card
                    UI.selectedUnit = u;
                    document.getElementById('entity-card').style.display = 'block';
                }
                document.getElementById('ctx-menu').style.display = 'none';
            }
        };

        // --- UI MANAGER ---
        const UI = {
            selectedUnit: null,

            handleWorldClick: (mx, my) => {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
                document.getElementById('ctx-menu').style.display = 'none';

                let clicked = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ —é–Ω–∏—Ç—É
                WORLD.units.forEach(u => {
                    if (Math.abs(u.x - mx) < 30 && Math.abs(u.y - 40 - my) < 50) {
                        // –ï—Å–ª–∏ –ü–ö–ú (button 2) - –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—É—Ç, —ç—Ç–æ –¥–µ–ª–∞–µ—Ç contextmenu event
                        // –¢—É—Ç –õ–ö–ú - —Ö–≤–∞—Ç–∞–µ–º
                        u.isGrabbed = true;
                        UI.selectedUnit = u;
                        UI.showCard(u);
                        clicked = true;
                    }
                });

                if(!clicked) {
                    UI.selectedUnit = null;
                    document.getElementById('entity-card').style.display = 'none';
                    // –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É
                    Game.spawnParticles(mx, my, 'rgba(138,43,226,0.3)', 3);
                }
            },

            showCard: (u) => {
                const card = document.getElementById('entity-card');
                card.style.display = 'block';
                document.getElementById('card-color').style.background = u.tribe;
                document.getElementById('card-name').innerText = "UNIT " + u.id;
            },

            updateLoop: () => {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ –≤ TopBar
                document.getElementById('ui-pop').innerText = WORLD.units.length;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                const h = Math.floor(WORLD.time / 100);
                const m = Math.floor((WORLD.time % 100) / 100 * 60);
                document.getElementById('ui-time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                document.getElementById('ui-weather').innerText = WORLD.rain ? "RAIN" : "CLEAR";

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                if(UI.selectedUnit && UI.selectedUnit.hp > 0) {
                    const u = UI.selectedUnit;
                    document.getElementById('card-state').innerText = u.state.toUpperCase();
                    document.getElementById('card-goal').innerText = u.goal;
                    
                    document.getElementById('bar-hp').style.width = u.hp + "%";
                    document.getElementById('txt-hp').innerText = Math.floor(u.hp) + "%";

                    document.getElementById('bar-hunger').style.width = u.hunger + "%";
                    document.getElementById('txt-hunger').innerText = Math.floor(u.hunger) + "%";

                    document.getElementById('bar-energy').style.width = u.energy + "%";
                    document.getElementById('txt-energy').innerText = Math.floor(u.energy) + "%";
                } else {
                     document.getElementById('entity-card').style.display = 'none';
                }
            },

            toggleSettings: () => {
                const win = document.getElementById('settings-win');
                win.classList.toggle('open');
                
                // –ü—Ä–∏–≤—è–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                if(win.classList.contains('open')) {
                    document.getElementById('set-grav').value = WORLD.gravity * 20;
                    document.getElementById('set-grav').oninput = (e) => WORLD.gravity = e.target.value / 20;
                    
                    document.getElementById('set-steal').checked = WORLD.settings.stealMouse;
                    document.getElementById('set-steal').onchange = (e) => WORLD.settings.stealMouse = e.target.checked;

                    document.getElementById('set-war').checked = WORLD.settings.warMode;
                    document.getElementById('set-war').onchange = (e) => WORLD.settings.warMode = e.target.checked;
                }
            }
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ü–ö–ú (–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é)
        window.addEventListener('contextmenu', e => {
            e.preventDefault();
            const mx = e.clientX;
            const my = e.clientY;
            
            WORLD.units.forEach(u => {
                if (Math.abs(u.x - mx) < 30 && Math.abs(u.y - 40 - my) < 50) {
                    UI.selectedUnit = u;
                    const menu = document.getElementById('ctx-menu');
                    menu.style.display = 'block';
                    menu.style.left = mx + 'px';
                    menu.style.top = my + 'px';
                }
            });
        });

        // –ó–ê–ü–£–°–ö –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò –°–¢–†–ê–ù–ò–¶–´
        window.onload = () => {
            // –ê–Ω–∏–º–∞—Ü–∏—è Intro
            setTimeout(() => {
                const boot = document.getElementById('boot-screen');
                boot.style.opacity = '0';
                setTimeout(() => {
                    boot.style.display = 'none';
                    Game.init();
                }, 800);
            }, 2500);
        };

    </script>
</body>
</html>
