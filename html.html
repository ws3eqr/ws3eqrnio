<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS3EQR | EVO X</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --ui: rgba(20,20,20,0.9); --accent: #8a2be2; --text: #fff; --danger: #ff4444; }
        * { margin:0; padding:0; box-sizing:border-box; user-select:none; font-family:'Inter',sans-serif; cursor:none; }
        body { background:var(--bg); overflow:hidden; color:var(--text); }
        
        #cursor {
            position:fixed; width:20px; height:20px; z-index:9999; pointer-events:none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="black" stroke-width="2"><path d="M5.5 3.21l10.8 15.6-5.6-.6-2.6 5.8-3.4-1.4 2.5-5.6H1.8z"/></svg>') no-repeat;
        }

        /* –ò–ì–†–û–í–û–ô –ú–ò–† */
        #world { position:fixed; top:0; left:0; width:100%; height:100%; }
        canvas { position:absolute; top:0; left:0; }
        #weather-layer { z-index: 5; pointer-events: none; opacity: 0.5; }
        #ui-layer { z-index: 100; position: absolute; width: 100%; height: 100%; pointer-events: none; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .hud {
            position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
            display:flex; gap:10px; pointer-events:all; padding:10px;
            background: var(--ui); border:1px solid #333; border-radius:12px;
            backdrop-filter: blur(10px);
        }
        .btn {
            background:#333; color:#fff; border:1px solid #444; padding:10px 20px;
            border-radius:6px; font-weight:bold; transition:0.2s; cursor:pointer; font-size:0.9rem;
        }
        .btn:hover { background:var(--accent); border-color:#fff; transform:translateY(-2px); }
        .btn-red:hover { background:var(--danger); }

        /* –ü–ê–ù–ï–õ–¨ –ò–ù–§–û */
        .info-card {
            position:absolute; top:20px; right:20px; width:280px;
            background:var(--ui); border:1px solid var(--accent); border-radius:12px;
            padding:15px; pointer-events:all; display:none; animation:fadeIn 0.2s;
        }
        .bar-cont { width:100%; height:6px; background:#333; margin:5px 0 10px; border-radius:3px; }
        .bar-val { height:100%; border-radius:3px; transition:width 0.2s; }
        h2 { font-family:'JetBrains Mono'; font-size:1.2rem; margin-bottom:5px; color:var(--accent); }
        small { color:#888; font-size:0.75rem; }

        /* –î–ï–ù–¨/–ù–û–ß–¨ –û–í–ï–†–õ–ï–ô */
        #sky-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background: #000; opacity: 0; pointer-events:none; z-index:2; transition: opacity 5s;
        }

        @keyframes fadeIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>
    <div id="cursor"></div>
    <div id="sky-overlay"></div>
    
    <div id="world">
        <canvas id="bg-canvas"></canvas>
        <canvas id="game-canvas"></canvas>
        <canvas id="weather-layer"></canvas>
    </div>

    <div id="ui-layer">
        <div class="info-card" id="info">
            <h2 id="i-name">Unit #001</h2>
            <small id="i-state">STATUS: IDLE</small>
            <div style="margin-top:10px">HEALTH</div>
            <div class="bar-cont"><div id="i-hp" class="bar-val" style="background:#ff4444; width:100%"></div></div>
            <div>HUNGER</div>
            <div class="bar-cont"><div id="i-hunger" class="bar-val" style="background:#ffbb33; width:100%"></div></div>
            <div>ENERGY</div>
            <div class="bar-cont"><div id="i-energy" class="bar-val" style="background:#00C851; width:100%"></div></div>
            <div style="margin-top:10px; font-size:0.8rem; color:#aaa;" id="i-inv">INVENTORY: Empty</div>
        </div>

        <div class="hud">
            <button class="btn" onclick="sys.spawnUnit()">+ UNIT</button>
            <button class="btn" onclick="sys.spawnItem('food')">+ FOOD</button>
            <button class="btn" onclick="sys.spawnItem('wood')">+ MATERIAL</button>
            <button class="btn" onclick="sys.toggleRain()">üåß RAIN</button>
            <button class="btn btn-red" onclick="sys.nuke()">‚ò¢ NUKE</button>
            <button class="btn" onclick="sys.save()">üíæ SAVE</button>
        </div>
        
        <div style="position:absolute; top:20px; left:20px; font-family:'JetBrains Mono'; color:#555;">
            TIME: <span id="clock" style="color:#fff">12:00</span> | CYCLE: <span id="day-cycle">DAY</span>
        </div>
    </div>

    <script>
        // --- –î–í–ò–ñ–û–ö EVO X ---
        const C = document.getElementById('game-canvas');
        const CTX = C.getContext('2d');
        const W_CANVAS = document.getElementById('weather-layer');
        const W_CTX = W_CANVAS.getContext('2d');
        const BG = document.getElementById('bg-canvas');
        const BG_CTX = BG.getContext('2d');
        
        let W, H;
        const MOUSE = { x: 0, y: 0, down: false };

        // –ö–û–ù–§–ò–ì –ú–ò–†–ê
        const WORLD = {
            gravity: 0.5,
            ground: 0,
            time: 1200, // 0-2400
            rain: false,
            units: [],
            items: [],
            particles: [],
            structures: [],
            idCounter: 0
        };

        // --- 1. –°–ò–°–¢–ï–ú–ê –Æ–ù–ò–¢–û–í (STICKMAN AI) ---
        class Unit {
            constructor(x, y, data = null) {
                if(data) { Object.assign(this, data); return; } // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

                this.id = `U-${++WORLD.idCounter}`;
                this.x = x || Math.random() * (W - 50);
                this.y = y || H - 100;
                this.vx = 0; this.vy = 0;
                this.color = `hsl(${Math.random()*360}, 70%, 60%)`;
                
                // Stats
                this.hp = 100;
                this.hunger = 100;
                this.energy = 100;
                this.state = 'idle'; // idle, move, work, sleep, fight, dead
                this.target = null;
                this.inventory = { wood: 0, food: 0 };
                
                // Animation
                this.frame = Math.random() * 100;
                this.dir = 1; // 1 right, -1 left
                this.msg = null;
                this.msgTimer = 0;
            }

            update() {
                if(this.state === 'dead') return;

                // 1. –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏
                this.hunger -= 0.05;
                this.energy -= 0.03;
                if(this.msgTimer > 0) this.msgTimer--; else this.msg = null;

                // 2. –ú–æ–∑–≥ (State Machine)
                this.think();

                // 3. –§–∏–∑–∏–∫–∞
                this.vy += WORLD.gravity;
                this.x += this.vx;
                this.y += this.vy;

                // –ö–æ–ª–ª–∏–∑–∏—è —Å –ø–æ–ª–æ–º
                if(this.y > WORLD.ground) {
                    this.y = WORLD.ground;
                    this.vy = 0;
                    this.vx *= 0.8; // –¢—Ä–µ–Ω–∏–µ
                }

                // –ö–æ–ª–ª–∏–∑–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏
                if(this.x < 0) { this.x = 0; this.vx *= -1; }
                if(this.x > W) { this.x = W; this.vx *= -1; }

                // –°–º–µ—Ä—Ç—å
                if(this.hp <= 0 || this.hunger <= 0) {
                    this.die();
                }
            }

            think() {
                // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –°–û–ù (–ù–æ—á—å—é)
                if ((WORLD.time > 2200 || WORLD.time < 500) && this.energy < 80) {
                    this.state = 'sleep';
                    this.say("Zzz...");
                    this.energy += 0.1;
                    return;
                }

                // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ì–û–õ–û–î
                if (this.hunger < 40) {
                    const food = this.findNearest('food');
                    if (food) {
                        this.state = 'move';
                        this.moveTo(food.x);
                        if(this.dist(food) < 30) {
                            this.eat(food);
                        }
                    } else {
                        this.state = 'idle';
                        this.say("–ì–æ–ª–æ–¥–µ–Ω!");
                    }
                    return;
                }

                // –ü–†–ò–û–†–ò–¢–ï–¢ 3: –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û
                if (this.inventory.wood >= 3) {
                    this.state = 'work';
                    // –°—Ç—Ä–æ–∏–º –±–∞—à–Ω—é
                    if(Math.random() < 0.01) {
                        WORLD.structures.push({x: this.x, y: this.y, w: 40, h: 40});
                        this.inventory.wood -= 3;
                        this.say("–°—Ç—Ä–æ–π–∫–∞!");
                        sys.particles(this.x, this.y, '#fff', 5);
                    }
                    return;
                }

                // –ü–†–ò–û–†–ò–¢–ï–¢ 4: –°–ë–û–† –†–ï–°–£–†–°–û–í
                const wood = this.findNearest('wood');
                if (wood && Math.random() < 0.02) {
                    this.target = wood;
                    this.state = 'move';
                }

                if (this.target && WORLD.items.includes(this.target)) {
                    this.moveTo(this.target.x);
                    if(this.dist(this.target) < 30) {
                        this.pickup(this.target);
                        this.target = null;
                    }
                } else {
                    // –°–ª—É—á–∞–π–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                    if (Math.random() < 0.02) {
                        this.state = 'move';
                        this.vx = (Math.random() - 0.5) * 4;
                        this.dir = Math.sign(this.vx) || 1;
                        if(Math.random() < 0.3) this.vy = -8; // Jump
                    } else {
                         if(Math.random() < 0.05) this.state = 'idle';
                    }
                }
            }

            moveTo(tx) {
                const dx = tx - this.x;
                this.vx += Math.sign(dx) * 0.2;
                this.dir = Math.sign(dx) || 1;
                if(Math.abs(this.vx) > 3) this.vx = 3 * Math.sign(this.vx);
            }

            dist(obj) { return Math.abs(this.x - obj.x) + Math.abs(this.y - obj.y); }
            
            findNearest(type) {
                let minDst = 9999;
                let res = null;
                WORLD.items.forEach(i => {
                    if(i.type === type) {
                        let d = this.dist(i);
                        if(d < minDst) { minDst = d; res = i; }
                    }
                });
                return res;
            }

            pickup(item) {
                this.inventory[item.type]++;
                WORLD.items.splice(WORLD.items.indexOf(item), 1);
                this.say("–í–∑—è–ª!");
            }

            eat(food) {
                this.hunger = 100;
                this.pickup(food); // –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –µ–¥—É —á–µ—Ä–µ–∑ pickup –ª–æ–≥–∏–∫—É, –Ω–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ç—Ä–∞—Ç–∏–º
                this.inventory.food--; 
                this.say("–í–∫—É—Å–Ω–æ");
                sys.particles(this.x, this.y, '#0f0', 5);
            }

            say(text) {
                this.msg = text;
                this.msgTimer = 60;
            }

            die() {
                this.state = 'dead';
                this.say("X_X");
                sys.particles(this.x, this.y, '#f00', 10);
                setTimeout(() => {
                    WORLD.units.splice(WORLD.units.indexOf(this), 1);
                }, 2000);
            }

            draw() {
                CTX.save();
                CTX.translate(this.x, this.y);
                if(this.state === 'dead') {
                    CTX.rotate(Math.PI/2);
                    CTX.fillStyle = '#555';
                } else {
                    CTX.fillStyle = this.color;
                }

                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –°—Ç–∏–∫–º–∞–Ω–∞
                CTX.strokeStyle = this.state === 'dead' ? '#555' : this.color;
                CTX.lineWidth = 3;
                CTX.lineCap = 'round';

                // –ù–æ–≥–∏ (–∞–Ω–∏–º–∞—Ü–∏—è)
                let walk = (this.state === 'move') ? Math.sin(Date.now() / 100) * 10 : 0;
                if(this.state === 'sleep') { 
                    CTX.rotate(Math.PI/2); walk = 0; 
                }

                CTX.beginPath();
                CTX.moveTo(0, -20); CTX.lineTo(-10 + walk, 0); // –õ–µ–≤–∞—è –Ω–æ–≥–∞
                CTX.moveTo(0, -20); CTX.lineTo(10 - walk, 0); // –ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞
                CTX.moveTo(0, -20); CTX.lineTo(0, -50); // –¢–µ–ª–æ
                CTX.moveTo(0, -45); CTX.lineTo(-15, -30 - walk); // –õ–µ–≤–∞—è —Ä—É–∫–∞
                CTX.moveTo(0, -45); CTX.lineTo(15, -30 + walk); // –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
                CTX.stroke();

                // –ì–æ–ª–æ–≤–∞
                CTX.beginPath(); CTX.arc(0, -60, 10, 0, Math.PI*2); 
                CTX.fillStyle='#000'; CTX.fill(); CTX.stroke();

                // –ì–ª–∞–∑–∞
                CTX.fillStyle = this.color;
                CTX.beginPath(); 
                CTX.arc(this.dir*4, -62, 2, 0, Math.PI*2);
                CTX.fill();

                // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–≤ —Ä—É–∫–∞—Ö)
                if(this.inventory.wood > 0) {
                    CTX.fillStyle = '#8B4513'; CTX.fillRect(15, -35, 10, 10);
                }

                // –°–æ–æ–±—â–µ–Ω–∏–µ
                if(this.msg) {
                    CTX.fillStyle = "#fff";
                    CTX.font = "12px Inter";
                    CTX.fillText(this.msg, -20, -80);
                }

                // HP Bar (–µ—Å–ª–∏ —Ä–∞–Ω–µ–Ω)
                if(this.hp < 100 && this.state !== 'dead') {
                    CTX.fillStyle = 'red'; CTX.fillRect(-15, -90, 30, 4);
                    CTX.fillStyle = '#0f0'; CTX.fillRect(-15, -90, 30 * (this.hp/100), 4);
                }

                CTX.restore();
            }
        }

        // --- 2. –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø (SYS) ---
        const sys = {
            init: () => {
                window.addEventListener('resize', sys.resize);
                sys.resize();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞
                const save = localStorage.getItem('ws3eqr_evo_save');
                if(save) {
                    try {
                        const data = JSON.parse(save);
                        data.units.forEach(u => WORLD.units.push(new Unit(u.x, u.y, u)));
                        WORLD.structures = data.structures || [];
                        WORLD.items = data.items || [];
                        console.log('Save loaded.');
                    } catch(e) { console.error(e); }
                } else {
                    for(let i=0; i<3; i++) sys.spawnUnit();
                }

                // –í–≤–æ–¥
                document.addEventListener('mousemove', e => {
                    MOUSE.x = e.clientX; MOUSE.y = e.clientY;
                    document.getElementById('cursor').style.transform = `translate(${MOUSE.x}px, ${MOUSE.y}px)`;
                });
                document.addEventListener('mousedown', e => {
                    MOUSE.down = true;
                    sys.checkClick(e.clientX, e.clientY);
                    document.getElementById('cursor').style.transform += " scale(0.8)";
                });
                document.addEventListener('mouseup', () => {
                    MOUSE.down = false;
                    document.getElementById('cursor').style.transform = document.getElementById('cursor').style.transform.replace(" scale(0.8)", "");
                });

                requestAnimationFrame(sys.loop);
            },

            resize: () => {
                W = window.innerWidth; H = window.innerHeight;
                C.width = W; C.height = H;
                W_CANVAS.width = W; W_CANVAS.height = H;
                BG.width = W; BG.height = H;
                WORLD.ground = H - 50;
            },

            spawnUnit: () => { WORLD.units.push(new Unit()); },
            
            spawnItem: (type) => {
                WORLD.items.push({
                    type: type,
                    x: Math.random() * (W-100) + 50,
                    y: 0,
                    vx: 0, vy: 0,
                    color: type === 'food' ? '#ffaa00' : '#8B4513'
                });
            },

            checkClick: (mx, my) => {
                let found = false;
                WORLD.units.forEach(u => {
                    if(Math.abs(u.x - mx) < 30 && Math.abs(u.y - 40 - my) < 50) {
                        sys.selectUnit(u);
                        found = true;
                    }
                });
                if(!found) {
                    document.getElementById('info').style.display = 'none';
                    // –ö–ª–∏–∫ –ø–æ –º–∏—Ä—É —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç
                    sys.particles(mx, my, 'rgba(138,43,226,0.5)', 3);
                }
            },

            selectUnit: (u) => {
                const p = document.getElementById('info');
                p.style.display = 'block';
                const updateUI = () => {
                    if(p.style.display === 'none') return;
                    document.getElementById('i-name').innerText = u.id;
                    document.getElementById('i-state').innerText = "STATUS: " + u.state.toUpperCase();
                    document.getElementById('i-hp').style.width = u.hp + "%";
                    document.getElementById('i-hunger').style.width = u.hunger + "%";
                    document.getElementById('i-energy').style.width = u.energy + "%";
                    document.getElementById('i-inv').innerText = `INV: Wood: ${u.inventory.wood} | Food: ${u.inventory.food}`;
                    if(WORLD.units.includes(u)) requestAnimationFrame(updateUI);
                    else p.style.display = 'none';
                };
                updateUI();
            },

            toggleRain: () => { WORLD.rain = !WORLD.rain; },
            
            nuke: () => {
                if(!confirm("–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Å–µ –∂–∏–≤–æ–µ?")) return;
                WORLD.units.forEach(u => sys.particles(u.x, u.y, '#f00', 20));
                WORLD.units = []; WORLD.items = []; WORLD.structures = [];
            },

            save: () => {
                const data = {
                    units: WORLD.units,
                    items: WORLD.items,
                    structures: WORLD.structures
                };
                localStorage.setItem('ws3eqr_evo_save', JSON.stringify(data));
                alert("–ú–∏—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
            },

            particles: (x, y, c, count) => {
                for(let i=0; i<count; i++) {
                    WORLD.particles.push({
                        x:x, y:y, 
                        vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                        life: 30, color: c
                    });
                }
            },

            loop: () => {
                // –û—á–∏—Å—Ç–∫–∞
                CTX.clearRect(0, 0, W, H);
                W_CTX.clearRect(0, 0, W, H);

                // --- –õ–û–ì–ò–ö–ê –í–†–ï–ú–ï–ù–ò ---
                WORLD.time += 0.5;
                if(WORLD.time >= 2400) WORLD.time = 0;
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                let mins = Math.floor((WORLD.time % 100) / 100 * 60);
                let hours = Math.floor(WORLD.time / 100);
                document.getElementById('clock').innerText = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
                
                // –°–º–µ–Ω–∞ –¥–Ω—è/–Ω–æ—á–∏
                const overlay = document.getElementById('sky-overlay');
                if(WORLD.time > 2000 || WORLD.time < 600) {
                    overlay.style.opacity = 0.8; // –ù–æ—á—å
                    document.getElementById('day-cycle').innerText = "NIGHT";
                    document.getElementById('day-cycle').style.color = "#8a2be2";
                } else {
                    overlay.style.opacity = 0; // –î–µ–Ω—å
                    document.getElementById('day-cycle').innerText = "DAY";
                    document.getElementById('day-cycle').style.color = "#ffbb33";
                }

                // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ò–†–ê ---
                
                // –°—Ç—Ä—É–∫—Ç—É—Ä—ã
                WORLD.structures.forEach(s => {
                    CTX.fillStyle = '#444';
                    CTX.fillRect(s.x, H - s.h, s.w, s.h);
                    CTX.strokeStyle = '#fff';
                    CTX.strokeRect(s.x, H - s.h, s.w, s.h);
                });

                // –ü—Ä–µ–¥–º–µ—Ç—ã
                WORLD.items.forEach((it, i) => {
                    it.y += 2; 
                    if(it.y > WORLD.ground) it.y = WORLD.ground;
                    CTX.fillStyle = it.color;
                    CTX.beginPath(); CTX.arc(it.x, it.y-5, 5, 0, Math.PI*2); CTX.fill();
                    // –¢–µ–∫—Å—Ç –Ω–∞–¥ –ø—Ä–µ–¥–º–µ—Ç–æ–º
                    CTX.fillStyle = "#fff"; CTX.font="10px Arial"; 
                    CTX.fillText(it.type === 'food' ? "üçî" : "ü™µ", it.x-5, it.y-10);
                });

                // –Æ–Ω–∏—Ç—ã
                WORLD.units.forEach(u => { u.update(); u.draw(); });

                // –ß–∞—Å—Ç–∏—Ü—ã
                WORLD.particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.life--;
                    CTX.fillStyle = p.color; CTX.fillRect(p.x, p.y, 3, 3);
                    if(p.life <= 0) WORLD.particles.splice(i, 1);
                });

                // --- –ü–û–ì–û–î–ê (–î–û–ñ–î–¨) ---
                if(WORLD.rain) {
                    W_CTX.strokeStyle = 'rgba(174, 194, 224, 0.5)';
                    W_CTX.lineWidth = 1;
                    for(let i=0; i<100; i++) {
                        let rx = Math.random() * W;
                        let ry = Math.random() * H;
                        W_CTX.beginPath(); W_CTX.moveTo(rx, ry); W_CTX.lineTo(rx - 2, ry + 10); W_CTX.stroke();
                    }
                }

                requestAnimationFrame(sys.loop);
            }
        };

        sys.init();
    </script>
</body>
</html>
