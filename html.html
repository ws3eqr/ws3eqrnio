<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WS3EQR | GENESIS ULTIMATE OS</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #050505; --glass-panel: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08); --accent: #8a2be2;
            --accent-glow: rgba(138, 43, 226, 0.5); --text-main: #ffffff;
            --success: #00ff88; --danger: #ff4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; cursor: none; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }

        #custom-cursor {
            position: fixed; width: 24px; height: 24px; z-index: 99999; pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="black" stroke-width="1.5"><path d="M5.5 3.21l10.8 15.6-5.6-.6-2.6 5.8-3.4-1.4 2.5-5.6H1.8z"/></svg>') no-repeat;
            filter: drop-shadow(0 0 5px var(--accent)); transition: transform 0.05s;
        }

        #world-layer, #weather-canvas, #lighting-layer, #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #weather-canvas, #lighting-layer, #ui-layer { pointer-events: none; }
        #lighting-layer { mix-blend-mode: multiply; z-index: 20; transition: background-color 1s; }
        #ui-layer { z-index: 100; }

        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: rgba(10, 10, 10, 0.8); border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            pointer-events: all; z-index: 1000; backdrop-filter: blur(10px);
        }
        .os-logo { font-weight: 900; letter-spacing: 1px; font-size: 0.9rem; }
        .os-logo span { color: var(--accent); }
        .os-stats { display: flex; gap: 20px; font-family: 'JetBrains Mono'; font-size: 0.75rem; color: #888; }

        .toolbar {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px 10px; display: flex; flex-direction: column; gap: 15px;
            backdrop-filter: blur(20px); pointer-events: all; transition: 0.3s;
        }
        .toolbar:hover { border-color: var(--accent); }
        
        .tool-btn {
            width: 40px; height: 40px; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.05); color: #fff; font-size: 1.2rem;
            cursor: none; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        #entity-card {
            position: absolute; right: 20px; top: 60px; width: 300px;
            background: rgba(15, 15, 15, 0.9); border: 1px solid var(--accent);
            border-radius: 12px; padding: 20px; backdrop-filter: blur(15px);
            display: none; pointer-events: all; animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .card-avatar { width: 50px; height: 50px; background: #222; border-radius: 50%; border: 2px solid #fff; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #aaa; }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        #ctx-menu {
            position: absolute; background: #1a1a1a; border: 1px solid #333;
            width: 180px; border-radius: 6px; padding: 5px; display: none; z-index: 5000; pointer-events: all;
        }
        .ctx-item { padding: 8px 12px; font-size: 0.85rem; color: #ccc; border-radius: 4px; display: flex; gap: 10px; align-items: center; }
        .ctx-item:hover { background: var(--accent); color: #fff; }
        
        .bubble {
            position: absolute; background: #fff; color: #000; padding: 5px 10px;
            border-radius: 10px; font-size: 0.75rem; font-weight: bold; pointer-events: none;
            transform: translate(-50%, -100%); white-space: nowrap; opacity: 0; transition: opacity 0.3s; z-index: 50;
        }
    </style>
</head>
<body>
    <div id="custom-cursor"></div>
    <div id="lighting-layer"></div>
    <canvas id="world-layer"></canvas>
    <canvas id="weather-canvas"></canvas>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="os-logo">WS3EQR <span>GENESIS</span></div>
            <div class="os-stats">
                <div class="stat-item"><i class="fa-solid fa-users"></i> POP: <span id="ui-pop">0</span></div>
                <div class="stat-item"><i class="fa-solid fa-clock"></i> TIME: <span id="ui-time">12:00</span></div>
                <div class="stat-item"><i class="fa-solid fa-cloud"></i> WEATHER: <span id="ui-weather">CLEAR</span></div>
            </div>
        </div>

        <div class="toolbar">
            <button class="tool-btn" onclick="Game.spawn('stickman')" title="Spawn Unit"><i class="fa-solid fa-person"></i></button>
            <button class="tool-btn" onclick="Game.spawn('food')" title="Drop Food"><i class="fa-solid fa-burger"></i></button>
            <button class="tool-btn" onclick="Game.spawn('wood')" title="Resources"><i class="fa-solid fa-cubes"></i></button>
            <button class="tool-btn" onclick="Game.toggleRain()" title="Rain"><i class="fa-solid fa-cloud-rain"></i></button>
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 5px 0;"></div>
            <button class="tool-btn" style="color:var(--danger)" onclick="Game.nuke()" title="NUKE"><i class="fa-solid fa-radiation"></i></button>
        </div>

        <div id="entity-card">
            <div class="card-header">
                <div class="card-avatar" id="card-color"></div>
                <div><div class="card-name" id="card-name">Unit-X</div><div class="card-role" id="card-state">IDLE</div></div>
            </div>
            <div class="stat-row"><span>Health</span><span id="txt-hp">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:var(--danger); width:100%" id="bar-hp"></div></div>
            <div class="stat-row"><span>Hunger</span><span id="txt-hunger">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:orange; width:100%" id="bar-hunger"></div></div>
            <div class="stat-row"><span>Energy</span><span id="txt-energy">100%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="background:var(--success); width:100%" id="bar-energy"></div></div>
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px; font-size:0.8rem; color:#888;">
                <i class="fa-solid fa-bullseye"></i> Goal: <span id="card-goal" style="color:#fff">None</span>
            </div>
        </div>

        <div id="ctx-menu">
            <div class="ctx-item" onclick="Game.ctxAction('inspect')"><i class="fa-solid fa-eye"></i> Inspect</div>
            <div class="ctx-item" onclick="Game.ctxAction('feed')"><i class="fa-solid fa-burger"></i> Feed</div>
            <div class="ctx-item" onclick="Game.ctxAction('kill')"><i class="fa-solid fa-skull"></i> Terminate</div>
        </div>
        <div id="bubbles-layer"></div>
    </div>

    <script>
        // --- –Ø–î–†–û –°–ò–ú–£–õ–Ø–¶–ò–ò ---
        const CANVAS = document.getElementById('world-layer');
        const CTX = CANVAS.getContext('2d');
        const W_CANVAS = document.getElementById('weather-canvas');
        const W_CTX = W_CANVAS.getContext('2d');
        
        let WIDTH, HEIGHT;
        let MOUSE = { x: 0, y: 0, down: false };
        let FRAME = 0;

        const WORLD = {
            gravity: 0.5, ground: 0, friction: 0.9, time: 800, rain: false,
            units: [], items: [], particles: [], structures: []
        };

        const Rnd = (min, max) => Math.random() * (max - min) + min;
        const Dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);

        // --- –ö–õ–ê–°–° –°–¢–ò–ö–ú–ê–ù–ê ---
        class Entity {
            constructor(x, y) {
                this.id = Math.random().toString(36).substr(2, 5).toUpperCase();
                this.x = x || Rnd(50, WIDTH - 50);
                this.y = y || WORLD.ground - 100;
                this.vx = 0; this.vy = 0;
                this.tribe = ['#ff4444', '#00ff88', '#8be9fd'][Math.floor(Math.random() * 3)];
                this.hp = 100; this.hunger = 100; this.energy = 100;
                this.state = 'idle'; this.target = null; this.goal = 'Waiting...';
                this.isGrabbed = false; this.frame = Rnd(0, 100); this.dir = 1;
                this.inventory = { wood: 0 };
            }

            update() {
                if (this.hp <= 0) return this.die();
                this.hunger -= 0.03; this.energy -= 0.02;

                if (this.isGrabbed) {
                    this.x = MOUSE.x; this.y = MOUSE.y; this.vx = 0; this.vy = 0;
                    this.state = 'panic'; return;
                }
                
                if (FRAME % 10 === 0) this.think(); 
                this.act();
                this.applyPhysics();
            }

            think() {
                const isNight = WORLD.time > 2000 || WORLD.time < 600;
                if ((this.energy < 20 || (isNight && this.energy < 90)) && this.state !== 'panic') {
                    this.setGoal('sleep', null, 'Zzz...'); return;
                }
                if (this.hunger < 50) {
                    const food = this.findNearest('food');
                    if (food) this.setGoal('eat', food, 'Searching Food');
                    else this.setGoal('wander', null, 'Hungry!');
                    return;
                }
                const wood = this.findNearest('wood');
                if (wood && Rnd(0, 1) < 0.3) { this.setGoal('gather', wood, 'Getting Wood'); return; }
                
                if (this.state === 'idle' || this.state === 'sleep') {
                    if (Rnd(0, 1) < 0.05) this.setGoal('wander', null, 'Exploring');
                }
            }

            act() {
                if(this.state === 'move' || this.state === 'eat' || this.state === 'gather') {
                    if(this.target) {
                        this.moveTo(this.target);
                        if(Dist(this, this.target) < 30) this.interact();
                    } else this.state = 'idle';
                }
                if(this.state === 'wander') {
                    if(Rnd(0,1) < 0.05) this.vx = Rnd(-2, 2);
                    if(this.x < 50) this.vx = 2; if(this.x > WIDTH - 50) this.vx = -2;
                }
                if(this.state === 'sleep') {
                    this.vx = 0; this.energy += 0.05;
                    if(this.energy >= 100) { this.energy = 100; this.state = 'idle'; this.say("Woke up"); }
                }
            }

            moveTo(t) {
                const dx = t.x - this.x;
                if (Math.abs(dx) > 10) {
                    this.vx += Math.sign(dx) * 0.5;
                    this.dir = Math.sign(dx);
                    if (this.vx > 4) this.vx = 4; if (this.vx < -4) this.vx = -4;
                } else this.vx *= 0.5;
            }

            interact() {
                if (this.state === 'eat') {
                    this.hunger = 100; this.say("Yummy!");
                    Game.removeObj(this.target, 'items');
                    Game.spawnParticles(this.x, this.y, '#0f0', 5);
                    this.state = 'idle';
                } else if (this.state === 'gather') {
                    this.inventory.wood++; this.say("+1 Wood");
                    Game.removeObj(this.target, 'items');
                    this.state = 'idle';
                }
            }

            applyPhysics() {
                this.vy += WORLD.gravity; this.x += this.vx; this.y += this.vy;
                if (this.y > WORLD.ground) { this.y = WORLD.ground; this.vy = 0; this.vx *= WORLD.friction; }
                if (this.x < 0) { this.x = 0; this.vx *= -1; }
                if (this.x > WIDTH) { this.x = WIDTH; this.vx *= -1; }
            }

            setGoal(s, t, g) { this.state = s; this.target = t; this.goal = g; }
            
            findNearest(type) {
                let min = Infinity; let res = null;
                WORLD.items.forEach(i => { if(i.type === type) { let d = Dist(this, i); if(d < min){ min = d; res = i; } } });
                return res;
            }

            say(text) {
                const b = document.createElement('div'); b.className = 'bubble'; b.innerText = text;
                b.style.left = this.x + 'px'; b.style.top = (this.y - 60) + 'px';
                document.getElementById('bubbles-layer').appendChild(b);
                setTimeout(() => b.style.opacity = 1, 10);
                setTimeout(() => { b.style.opacity = 0; setTimeout(() => b.remove(), 300); }, 2000);
            }

            die() { Game.spawnParticles(this.x, this.y, '#fff', 20); Game.removeObj(this, 'units'); }

            draw() {
                CTX.save(); CTX.translate(this.x, this.y);
                CTX.strokeStyle = this.tribe; CTX.lineWidth = 3; CTX.lineCap = 'round';
                CTX.shadowBlur = 10; CTX.shadowColor = this.tribe;

                let leg = (Math.abs(this.vx) > 0.1) ? Math.sin(FRAME * 0.2) * 10 : 0;
                if (this.state === 'sleep') { CTX.rotate(Math.PI / 2); leg = 0; }

                CTX.beginPath();
                CTX.moveTo(0, -20); CTX.lineTo(-10 + leg, 0); 
                CTX.moveTo(0, -20); CTX.lineTo(10 - leg, 0);
                CTX.moveTo(0, -20); CTX.lineTo(0, -50); // –¢–µ–ª–æ
                CTX.moveTo(0, -45); CTX.lineTo(-15, -30 + leg); 
                CTX.moveTo(0, -45); CTX.lineTo(15, -30 - leg);
                CTX.stroke();

                CTX.fillStyle = '#000'; CTX.beginPath(); CTX.arc(0, -60, 10, 0, Math.PI*2); CTX.fill(); CTX.stroke();
                CTX.fillStyle = '#fff'; CTX.beginPath(); CTX.arc(this.dir * 3, -62, 2, 0, Math.PI*2); CTX.fill();
                CTX.restore();
            }
        }

        class Item {
            constructor(type, x, y) {
                this.type = type; this.x = x; this.y = y;
                this.color = type === 'food' ? '#ffaa00' : '#8B4513';
                this.icon = type === 'food' ? 'üçî' : 'ü™µ';
            }
            draw() {
                CTX.fillStyle = this.color; CTX.shadowBlur = 0;
                CTX.beginPath(); CTX.arc(this.x, this.y - 5, 5, 0, Math.PI*2); CTX.fill();
                CTX.font = "12px Arial"; CTX.textAlign = "center"; CTX.fillText(this.icon, this.x, this.y - 10);
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color; this.life = 1.0;
                this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; this.vy += 0.2; }
            draw() { CTX.globalAlpha = this.life; CTX.fillStyle = this.color; CTX.fillRect(this.x, this.y, 4, 4); CTX.globalAlpha = 1; }
        }

        // --- –î–í–ò–ñ–û–ö ---
        const Game = {
            init: () => {
                Game.resize(); window.addEventListener('resize', Game.resize);
                document.addEventListener('mousemove', e => {
                    MOUSE.x = e.clientX; MOUSE.y = e.clientY;
                    document.getElementById('custom-cursor').style.transform = `translate(${MOUSE.x}px, ${MOUSE.y}px)`;
                });
                document.addEventListener('mousedown', e => {
                    MOUSE.down = true; UI.handleWorldClick(e.clientX, e.clientY);
                    document.getElementById('custom-cursor').style.transform += " scale(0.8)";
                });
                document.addEventListener('mouseup', () => {
                    MOUSE.down = false; WORLD.units.forEach(u => u.isGrabbed = false);
                    document.getElementById('custom-cursor').style.transform = document.getElementById('custom-cursor').style.transform.replace(" scale(0.8)", "");
                });
                for(let i=0; i<3; i++) Game.spawn('stickman');
                Game.loop();
            },
            resize: () => {
                WIDTH = window.innerWidth; HEIGHT = window.innerHeight;
                CANVAS.width = WIDTH; CANVAS.height = HEIGHT;
                W_CANVAS.width = WIDTH; W_CANVAS.height = HEIGHT;
                WORLD.ground = HEIGHT - 50;
            },
            loop: () => {
                CTX.clearRect(0, 0, WIDTH, HEIGHT); W_CTX.clearRect(0, 0, WIDTH, HEIGHT);
                Game.updateTime();
                WORLD.items.forEach(i => i.draw());
                WORLD.units.forEach(u => { u.update(); u.draw(); });
                WORLD.particles.forEach((p, i) => { p.update(); p.draw(); if(p.life <= 0) WORLD.particles.splice(i, 1); });
                if(WORLD.rain) Game.drawRain();
                FRAME++; UI.updateLoop();
                requestAnimationFrame(Game.loop);
            },
            updateTime: () => {
                WORLD.time += 0.5; if(WORLD.time >= 2400) WORLD.time = 0;
                const layer = document.getElementById('lighting-layer');
                if(WORLD.time > 2000 || WORLD.time < 600) layer.style.backgroundColor = "rgba(0, 5, 20, 0.85)";
                else if (WORLD.time > 600 && WORLD.time < 800) layer.style.backgroundColor = "rgba(255, 100, 50, 0.2)";
                else layer.style.backgroundColor = "transparent";
            },
            spawn: (type) => {
                if(type === 'stickman') { WORLD.units.push(new Entity(MOUSE.x, MOUSE.y)); Game.spawnParticles(MOUSE.x, MOUSE.y, '#fff', 10); }
                else if(type === 'food' || type === 'wood') WORLD.items.push(new Item(type, MOUSE.x || Rnd(0, WIDTH), 50));
            },
            spawnParticles: (x, y, c, count) => { for(let i=0; i<count; i++) WORLD.particles.push(new Particle(x, y, c)); },
            removeObj: (obj, list) => { const idx = WORLD[list].indexOf(obj); if(idx > -1) WORLD[list].splice(idx, 1); },
            drawRain: () => {
                W_CTX.strokeStyle = 'rgba(100, 150, 255, 0.3)'; W_CTX.lineWidth = 1; W_CTX.beginPath();
                for(let i=0; i<100; i++) { const x = Rnd(0, WIDTH); const y = Rnd(0, HEIGHT); W_CTX.moveTo(x, y); W_CTX.lineTo(x-2, y+15); }
                W_CTX.stroke();
            },
            toggleRain: () => { WORLD.rain = !WORLD.rain; },
            nuke: () => {
                if(confirm("NUKE?")) {
                    WORLD.units.forEach(u => Game.spawnParticles(u.x, u.y, '#f00', 50));
                    WORLD.units = []; WORLD.items = [];
                }
            },
            ctxAction: (a) => {
                const u = UI.selectedUnit; if(!u) return;
                if(a === 'kill') u.die(); if(a === 'feed') { u.hunger=100; u.say("Thanks"); }
                if(a === 'inspect') { UI.selectedUnit = u; document.getElementById('entity-card').style.display = 'block'; }
                document.getElementById('ctx-menu').style.display = 'none';
            }
        };

        const UI = {
            selectedUnit: null,
            handleWorldClick: (mx, my) => {
                document.getElementById('ctx-menu').style.display = 'none';
                let clicked = false;
                WORLD.units.forEach(u => {
                    if (Math.abs(u.x - mx) < 30 && Math.abs(u.y - 40 - my) < 50) {
                        u.isGrabbed = true; UI.selectedUnit = u; UI.showCard(u); clicked = true;
                    }
                });
                if(!clicked) { UI.selectedUnit = null; document.getElementById('entity-card').style.display = 'none'; }
            },
            showCard: (u) => {
                document.getElementById('entity-card').style.display = 'block';
                document.getElementById('card-color').style.background = u.tribe;
                document.getElementById('card-name').innerText = "UNIT " + u.id;
            },
            updateLoop: () => {
                document.getElementById('ui-pop').innerText = WORLD.units.length;
                const h = Math.floor(WORLD.time / 100); const m = Math.floor((WORLD.time % 100) / 100 * 60);
                document.getElementById('ui-time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                document.getElementById('ui-weather').innerText = WORLD.rain ? "RAIN" : "CLEAR";
                
                if(UI.selectedUnit && UI.selectedUnit.hp > 0) {
                    const u = UI.selectedUnit;
                    document.getElementById('card-state').innerText = u.state.toUpperCase();
                    document.getElementById('card-goal').innerText = u.goal;
                    document.getElementById('bar-hp').style.width = u.hp + "%";
                    document.getElementById('bar-hunger').style.width = u.hunger + "%";
                    document.getElementById('bar-energy').style.width = u.energy + "%";
                } else document.getElementById('entity-card').style.display = 'none';
            }
        };

        window.addEventListener('contextmenu', e => {
            e.preventDefault();
            const mx = e.clientX; const my = e.clientY;
            WORLD.units.forEach(u => {
                if (Math.abs(u.x - mx) < 30 && Math.abs(u.y - 40 - my) < 50) {
                    UI.selectedUnit = u;
                    const menu = document.getElementById('ctx-menu');
                    menu.style.display = 'block'; menu.style.left = mx + 'px'; menu.style.top = my + 'px';
                }
            });
        });

        window.onload = Game.init;
    </script>
</body>
</html>
